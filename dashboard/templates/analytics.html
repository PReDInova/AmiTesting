{% extends "base.html" %}
{% block title %}Trade Intelligence - AmiTesting{% endblock %}

{% block extra_head %}
<style>
    .analytics-card {
        border-left: 4px solid #0d6efd;
        margin-bottom: 1rem;
    }
    .analytics-card.green { border-left-color: #198754; }
    .analytics-card.red { border-left-color: #dc3545; }
    .analytics-card.amber { border-left-color: #ffc107; }
    .stat-big { font-size: 2rem; font-weight: 700; line-height: 1.2; }
    .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; color: #6c757d; }
    .pnl-bar { height: 24px; border-radius: 4px; min-width: 2px; }
    .chart-container { min-height: 200px; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h4 class="mb-0">
        <i class="bi bi-bar-chart-line me-2 text-primary"></i>Trade Intelligence
    </h4>
    <div class="d-flex gap-2">
        <select id="strategyFilter" class="form-select form-select-sm" style="width: auto;" onchange="refreshAll()">
            <option value="">All Strategies</option>
            {% for s in strategies %}
            <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
        </select>
        <select id="daysFilter" class="form-select form-select-sm" style="width: auto;" onchange="refreshAll()">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
        </select>
    </div>
</div>

<!-- Summary Row -->
<div class="row g-3 mb-4" id="summaryRow">
    <div class="col-md-3">
        <div class="card analytics-card green text-center p-3">
            <div class="stat-big text-success" id="totalPnl">$0.00</div>
            <div class="stat-label">Total P&L</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card analytics-card text-center p-3">
            <div class="stat-big" id="totalTrades">0</div>
            <div class="stat-label">Total Trades</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card analytics-card amber text-center p-3">
            <div class="stat-big" id="winRate">0%</div>
            <div class="stat-label">Win Rate</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card analytics-card text-center p-3">
            <div class="stat-big" id="totalSignals">0</div>
            <div class="stat-label">Total Signals</div>
        </div>
    </div>
</div>

<!-- P&L Attribution -->
<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-pie-chart me-2"></i>P&L by Strategy</span>
            </div>
            <div class="card-body" id="pnlByStrategy">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span><i class="bi bi-graph-up me-2"></i>P&L by Symbol</span>
            </div>
            <div class="card-body" id="pnlBySymbol">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock me-2"></i>P&L by Hour of Day
            </div>
            <div class="card-body" id="pnlByHour">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar-week me-2"></i>P&L by Day of Week
            </div>
            <div class="card-body" id="pnlByWeekday">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Signal Accuracy -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye me-2"></i>Signal Accuracy & Profitability
            </div>
            <div class="card-body" id="signalAccuracy">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Signal Activity by Hour -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history me-2"></i>Signal Activity by Hour
            </div>
            <div class="card-body" id="signalByHour">
                <div class="text-center text-muted py-3">Loading...</div>
            </div>
        </div>
    </div>
</div>

<!-- Daily P&L Timeline -->
<div class="row g-3 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar3 me-2"></i>Recent Trades
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Strategy</th>
                                <th>Signal</th>
                                <th>Symbol</th>
                                <th>Fill Price</th>
                                <th>Status</th>
                                <th>P&L</th>
                            </tr>
                        </thead>
                        <tbody id="recentTrades">
                            <tr><td colspan="7" class="text-center text-muted py-3">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

function getFilters() {
    return {
        strategy_id: document.getElementById('strategyFilter').value,
        days: parseInt(document.getElementById('daysFilter').value),
    };
}

function refreshAll() {
    const f = getFilters();
    loadPnlAttribution('strategy', 'pnlByStrategy', f);
    loadPnlAttribution('symbol', 'pnlBySymbol', f);
    loadPnlAttribution('hour', 'pnlByHour', f);
    loadPnlAttribution('weekday', 'pnlByWeekday', f);
    loadSignalAccuracy(f);
    loadRecentTrades(f);
    loadSummary(f);
}

function loadSummary(f) {
    // Fetch trade summary stats
    const params = new URLSearchParams({days: f.days});
    if (f.strategy_id) params.set('strategy_id', f.strategy_id);

    fetch('/api/trades?' + params.toString() + '&limit=10000')
        .then(r => r.json())
        .then(trades => {
            const filled = trades.filter(t => t.status === 'filled');
            const totalPnl = filled.reduce((s, t) => s + (t.pnl || 0), 0);
            const wins = filled.filter(t => t.pnl > 0).length;
            const wr = filled.length > 0 ? (wins / filled.length * 100).toFixed(1) : '0';

            document.getElementById('totalTrades').textContent = filled.length;
            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = '$' + totalPnl.toFixed(2);
            pnlEl.className = 'stat-big ' + (totalPnl >= 0 ? 'text-success' : 'text-danger');
            document.getElementById('winRate').textContent = wr + '%';
        });

    fetch('/api/signals/accuracy?' + params.toString())
        .then(r => r.json())
        .then(data => {
            document.getElementById('totalSignals').textContent = data.total_signals || 0;
        });
}

function loadPnlAttribution(groupBy, containerId, f) {
    const params = new URLSearchParams({group_by: groupBy, days: f.days});
    fetch('/api/trades/pnl?' + params.toString())
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById(containerId);
            if (!data.length) {
                container.innerHTML = '<div class="text-center text-muted py-3">No trade data available</div>';
                return;
            }

            let html = '<table class="table table-sm mb-0"><thead><tr><th>Group</th><th>Trades</th><th>Wins</th><th>Win %</th><th>Total P&L</th><th>Avg P&L</th></tr></thead><tbody>';
            data.forEach(row => {
                let label = row.group_key || 'N/A';
                if (groupBy === 'weekday' && label >= 0 && label <= 6) label = weekdayNames[parseInt(label)];
                if (groupBy === 'hour' && label !== null) label = label + ':00';

                const wr = row.trade_count > 0 ? ((row.win_count / row.trade_count) * 100).toFixed(1) : '0';
                const pnlClass = row.total_pnl >= 0 ? 'text-success' : 'text-danger';

                // Visual bar
                const maxPnl = Math.max(...data.map(r => Math.abs(r.total_pnl))) || 1;
                const barWidth = Math.abs(row.total_pnl) / maxPnl * 100;
                const barColor = row.total_pnl >= 0 ? '#198754' : '#dc3545';

                html += '<tr>' +
                    '<td>' + label + '</td>' +
                    '<td>' + row.trade_count + '</td>' +
                    '<td>' + row.win_count + '</td>' +
                    '<td>' + wr + '%</td>' +
                    '<td class="' + pnlClass + ' fw-bold">$' + row.total_pnl.toFixed(2) +
                    '<div class="pnl-bar mt-1" style="width:' + barWidth + '%; background:' + barColor + ';"></div></td>' +
                    '<td>$' + row.avg_pnl.toFixed(2) + '</td>' +
                    '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        })
        .catch(() => {
            document.getElementById(containerId).innerHTML = '<div class="text-muted py-3">Failed to load</div>';
        });
}

function loadSignalAccuracy(f) {
    const params = new URLSearchParams({days: f.days});
    if (f.strategy_id) params.set('strategy_id', f.strategy_id);

    fetch('/api/signals/accuracy?' + params.toString())
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('signalAccuracy');

            let html = '<div class="row mb-3">';
            html += '<div class="col-md-4"><div class="card p-3 text-center"><div class="stat-big">' + (data.total_signals || 0) + '</div><div class="stat-label">Total Signals</div></div></div>';
            html += '<div class="col-md-4"><div class="card p-3 text-center"><div class="stat-big text-success">' + (data.traded_signals || 0) + '</div><div class="stat-label">Traded</div></div></div>';
            html += '<div class="col-md-4"><div class="card p-3 text-center"><div class="stat-big text-muted">' + (data.deduped_signals || 0) + '</div><div class="stat-label">Deduped / Skipped</div></div></div>';
            html += '</div>';

            // By type breakdown
            const byType = data.by_type || {};
            if (Object.keys(byType).length > 0) {
                html += '<h6 class="mt-3">By Signal Type</h6>';
                html += '<table class="table table-sm"><thead><tr><th>Type</th><th>Count</th><th>Traded</th><th>Trade Rate</th></tr></thead><tbody>';
                Object.entries(byType).forEach(([type, info]) => {
                    const rate = info.count > 0 ? ((info.traded / info.count) * 100).toFixed(1) : '0';
                    const badge = (type === 'Buy' || type === 'Cover') ? 'bg-success' : 'bg-danger';
                    html += '<tr><td><span class="badge ' + badge + '">' + type + '</span></td><td>' + info.count + '</td><td>' + info.traded + '</td><td>' + rate + '%</td></tr>';
                });
                html += '</tbody></table>';
            }

            // Profitability
            const prof = data.profitability || {};
            if (Object.keys(prof).length > 0) {
                html += '<h6 class="mt-3">Signal Profitability (signals matched to trades)</h6>';
                html += '<table class="table table-sm"><thead><tr><th>Type</th><th>Signals</th><th>Trades</th><th>Wins</th><th>Losses</th><th>Win Rate</th><th>Total P&L</th><th>Avg P&L</th></tr></thead><tbody>';
                Object.entries(prof).forEach(([type, info]) => {
                    const pnlClass = info.total_pnl >= 0 ? 'text-success' : 'text-danger';
                    html += '<tr><td><span class="badge ' + ((type === 'Buy' || type === 'Cover') ? 'bg-success' : 'bg-danger') + '">' + type + '</span></td>' +
                        '<td>' + info.signal_count + '</td><td>' + info.trade_count + '</td>' +
                        '<td class="text-success">' + info.wins + '</td><td class="text-danger">' + info.losses + '</td>' +
                        '<td>' + info.win_rate + '%</td>' +
                        '<td class="' + pnlClass + ' fw-bold">$' + info.total_pnl.toFixed(2) + '</td>' +
                        '<td>$' + info.avg_pnl.toFixed(2) + '</td></tr>';
                });
                html += '</tbody></table>';
            }

            container.innerHTML = html;
        })
        .catch(() => {
            document.getElementById('signalAccuracy').innerHTML = '<div class="text-muted py-3">Failed to load</div>';
        });

    // Signal by hour
    fetch('/api/signals/accuracy?' + params.toString())
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('signalByHour');
            const byHour = data.by_hour || {};
            if (Object.keys(byHour).length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No hourly data available</div>';
                return;
            }

            // Build visual bars for each hour
            const maxCount = Math.max(...Object.values(byHour).map(h => h.count)) || 1;
            let html = '<div class="d-flex align-items-end gap-1" style="height: 120px;">';
            for (let h = 0; h < 24; h++) {
                const key = String(h).padStart(2, '0');
                const info = byHour[key] || {count: 0, traded: 0};
                const height = (info.count / maxCount) * 100;
                const tradedHeight = info.traded ? (info.traded / maxCount) * 100 : 0;
                html += '<div class="text-center flex-fill" title="' + key + ':00 - ' + info.count + ' signals, ' + (info.traded || 0) + ' traded">' +
                    '<div style="height: ' + height + 'px; background: #0d6efd; border-radius: 2px 2px 0 0; position: relative;">' +
                    (tradedHeight > 0 ? '<div style="position:absolute; bottom:0; left:0; right:0; height:' + tradedHeight + 'px; background:#198754; border-radius: 0 0 2px 2px;"></div>' : '') +
                    '</div>' +
                    '<small class="text-muted" style="font-size: 0.65rem;">' + h + '</small></div>';
            }
            html += '</div>';
            html += '<div class="d-flex gap-3 mt-2 justify-content-center"><small><span style="display:inline-block;width:12px;height:12px;background:#0d6efd;border-radius:2px;"></span> Total</small><small><span style="display:inline-block;width:12px;height:12px;background:#198754;border-radius:2px;"></span> Traded</small></div>';
            container.innerHTML = html;
        });
}

function loadRecentTrades(f) {
    const params = new URLSearchParams({limit: 50});
    if (f.strategy_id) params.set('strategy_id', f.strategy_id);

    fetch('/api/trades?' + params.toString())
        .then(r => r.json())
        .then(trades => {
            const tbody = document.getElementById('recentTrades');
            if (!trades.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-3">No trades recorded yet</td></tr>';
                return;
            }

            let html = '';
            trades.forEach(t => {
                const time = t.executed_at ? t.executed_at.substring(0, 19) : (t.created_at ? t.created_at.substring(0, 19) : '-');
                const badge = (t.signal_type === 'Buy' || t.signal_type === 'Cover') ? 'bg-success' : 'bg-danger';
                const statusBadge = t.status === 'filled' ? 'bg-success' : (t.status === 'pending' ? 'bg-warning' : 'bg-danger');
                const pnlClass = t.pnl > 0 ? 'text-success' : (t.pnl < 0 ? 'text-danger' : '');

                html += '<tr>' +
                    '<td class="small">' + time + '</td>' +
                    '<td>' + (t.strategy_name || '-') + '</td>' +
                    '<td><span class="badge ' + badge + '">' + t.signal_type + '</span></td>' +
                    '<td>' + t.symbol + '</td>' +
                    '<td>' + (t.fill_price ? t.fill_price.toFixed(2) : '-') + '</td>' +
                    '<td><span class="badge ' + statusBadge + '">' + t.status + '</span></td>' +
                    '<td class="' + pnlClass + '">' + (t.pnl ? '$' + t.pnl.toFixed(2) : '-') + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = html;
        });
}

// Initial load
refreshAll();
</script>
{% endblock %}
