{% extends "base.html" %}

{% block title %}Batch Runs â€” AmiTesting{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">Batch Runs</li>
    </ol>
</nav>

<!-- Header -->
<div class="d-flex align-items-center justify-content-between mb-4">
    <div>
        <h2 class="fw-bold mb-1">Batch Runs</h2>
        <p class="text-muted mb-0">History of batch backtest executions</p>
    </div>
    <button class="btn btn-success" id="batchRunBtn" onclick="startBatchBacktest()"
        {% if not db_configured %}disabled title="Configure AmiBroker database first"{% endif %}>
        <i class="bi bi-collection-play me-1"></i>Run All Strategies
    </button>
</div>

{% if batches %}
<div class="card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Mode</th>
                        <th class="text-center">Progress</th>
                        <th>Started</th>
                        <th>Completed</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for b in batches %}
                    <tr>
                        <td>
                            <a href="/batch/{{ b.id }}" class="text-decoration-none fw-bold">
                                {{ b.name or b.id[:12] + '...' }}
                            </a>
                        </td>
                        <td>
                            {% if b.status == "running" %}
                            <span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1"></span>Running</span>
                            {% elif b.status == "completed" %}
                            <span class="badge bg-success">Completed</span>
                            {% elif b.status == "cancelled" %}
                            <span class="badge bg-warning text-dark">Cancelled</span>
                            {% elif b.status == "failed" %}
                            <span class="badge bg-danger">Failed</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ b.status|title }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-light text-dark border">
                                {{ 'Optimization' if b.run_mode == 4 else 'Backtest' }}
                            </span>
                        </td>
                        <td class="text-center">
                            <span class="text-success fw-bold">{{ b.completed_count }}</span>
                            {% if b.failed_count > 0 %}
                            / <span class="text-danger">{{ b.failed_count }}</span>
                            {% endif %}
                            / {{ b.total_count }}
                        </td>
                        <td><small class="text-muted">{{ b.started_at[:19] if b.started_at else '--' }}</small></td>
                        <td><small class="text-muted">{{ b.completed_at[:19] if b.completed_at else '--' }}</small></td>
                        <td>
                            <a href="/batch/{{ b.id }}" class="btn btn-sm btn-outline-primary">
                                View <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-collection-play text-muted" style="font-size: 3rem;"></i>
        <p class="text-muted mt-3 mb-2">No batch runs yet.</p>
        <button class="btn btn-success" onclick="startBatchBacktest()"
            {% if not db_configured %}disabled{% endif %}>
            <i class="bi bi-play-fill me-1"></i>Run All Strategies
        </button>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
function startBatchBacktest() {
    const btn = document.getElementById('batchRunBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Starting...';
    }

    fetch('/api/batch/backtest', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.batch_id) {
            window.location.href = '/batch/' + data.batch_id;
        } else {
            alert(data.error || 'Failed to start batch');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-collection-play me-1"></i>Run All Strategies';
            }
        }
    })
    .catch(err => {
        alert('Error: ' + err);
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-collection-play me-1"></i>Run All Strategies';
        }
    });
}
</script>
{% endblock %}
