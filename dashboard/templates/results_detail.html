{% extends "base.html" %}

{% block title %}{{ filename }} — AmiTesting{% endblock %}

{% block extra_head %}
<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/edit/matchbrackets.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/addon/selection/active-line.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Lightweight Charts (TradingView) for candlestick charts -->
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>

<style>
    /* ── CodeMirror Overrides ──────────────────────────── */
    .CodeMirror {
        border: 1px solid #dee2e6;
        border-radius: 0 0 6px 6px;
        font-size: 13px;
    }

    /* ── Toggle Pill ──────────────────────────────────── */
    .toggle-pill .btn {
        border-radius: 20px;
        font-size: 0.8rem;
        padding: 4px 16px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    .toggle-pill .btn.active {
        background-color: #3b82f6;
        color: #fff;
        border-color: #3b82f6;
    }
    .toggle-pill .btn:not(.active) {
        background-color: transparent;
        color: #64748b;
        border-color: #cbd5e1;
    }
    .toggle-pill .btn:not(.active):hover {
        background-color: #f1f5f9;
        color: #334155;
    }

    /* ── Version History ──────────────────────────────── */
    .version-item {
        padding: 8px 12px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 0.85rem;
    }
    .version-item:last-child {
        border-bottom: none;
    }
    .version-item:hover {
        background-color: #f8fafc;
    }

    /* ── Summary Stats ────────────────────────────────── */
    .summary-stat {
        text-align: center;
        padding: 8px;
    }
    .summary-stat .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: #1e293b;
    }
    .summary-stat .stat-label {
        font-size: 0.72rem;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* ── Workbench Layout ─────────────────────────────── */
    .workbench-card {
        transition: none;
    }
    .workbench-card:hover {
        transform: none;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    /* ── Header Bar ───────────────────────────────────── */
    .header-bar {
        background: #fff;
        border-radius: 10px;
        padding: 0.75rem 1.25rem;
        box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }

    /* ── Compact Metric Cards (workbench) ─────────────── */
    .metric-card-sm {
        border-left: 3px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        transition: transform 0.15s ease;
    }
    .metric-card-sm:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.07);
    }
    .metric-card-sm .metric-value {
        font-size: 1.35rem;
        font-weight: 700;
        line-height: 1.2;
    }
    .metric-card-sm .metric-label {
        font-size: 0.72rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #6c757d;
        margin-top: 0.15rem;
    }
    .metric-card-sm.border-blue   { border-left-color: #0d6efd; }
    .metric-card-sm.border-green  { border-left-color: #198754; }
    .metric-card-sm.border-red    { border-left-color: #dc3545; }
    .metric-card-sm.border-gray   { border-left-color: #6c757d; }
    .metric-card-sm.border-amber  { border-left-color: #ffc107; }

    /* ── Version Preview Modal ────────────────────────── */
    #versionPreviewBody {
        max-height: 400px;
        overflow-y: auto;
    }

    /* ── Candlestick Chart (Sprint 3) ────────────────── */
    .trade-row-clickable {
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .trade-row-clickable:hover {
        background-color: rgba(59, 130, 246, 0.08) !important;
        outline: 2px solid rgba(59, 130, 246, 0.3);
        outline-offset: -2px;
    }
    #candlestickChartContainer {
        width: 100%;
        height: 400px;
        position: relative;
    }
    .chart-loading-overlay {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.9);
        z-index: 10;
    }
    /* Trade chart data tooltip */
    .trade-data-tooltip {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 20;
        background: rgba(255,255,255,0.92);
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 0.75rem;
        line-height: 1.5;
        pointer-events: none;
        display: none;
        min-width: 140px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
    .trade-data-tooltip.visible { display: block; }
    .trade-data-tooltip .tt-time { font-weight: 600; margin-bottom: 2px; color: #555; }
    .trade-data-tooltip .tt-row { display: flex; justify-content: space-between; gap: 12px; }
    .trade-data-tooltip .tt-label { color: #888; }
    .trade-data-tooltip .tt-val { font-weight: 500; font-variant-numeric: tabular-nums; }
    .trade-data-tooltip .tt-up { color: #26a69a; }
    .trade-data-tooltip .tt-down { color: #ef5350; }
    .trade-data-tooltip .tt-divider { border-top: 1px solid #eee; margin: 3px 0; }
</style>
{% endblock %}

{% block content %}
{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ROW 1 — Compact Header Bar
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
<nav aria-label="breadcrumb" class="mb-2">
    <ol class="breadcrumb mb-0" style="font-size: 0.82rem;">
        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">Home</a></li>
        {% if run and run.strategy %}
        <li class="breadcrumb-item"><a href="/strategy/{{ run.strategy_id }}" class="text-decoration-none">{{ run.strategy.name }}</a></li>
        <li class="breadcrumb-item active">Run {{ run.id[:8] }}...</li>
        {% else %}
        <li class="breadcrumb-item">Results</li>
        <li class="breadcrumb-item active">{{ filename }}</li>
        {% endif %}
    </ol>
</nav>

{% if run %}
<div class="d-flex gap-2 align-items-center mb-2 flex-wrap">
    <span class="badge bg-light text-dark border small">
        <i class="bi bi-hash me-1"></i>Run {{ run.id[:8] }}
    </span>
    {% if run.version %}
    <span class="badge bg-primary small">v{{ run.version.version_number }}</span>
    {% if run.version.label %}
    <span class="badge bg-light text-dark border small">{{ run.version.label }}</span>
    {% endif %}
    {% endif %}
    {% if run.status == "completed" %}
    <span class="badge bg-success small">Completed</span>
    {% elif run.status == "failed" %}
    <span class="badge bg-danger small">Failed</span>
    {% elif run.status == "running" %}
    <span class="badge bg-info small">Running</span>
    {% endif %}
    {% if run and run.symbol == '__ALL__' %}
    <span class="badge bg-info text-white">
        <i class="bi bi-collection me-1"></i>All Symbols
    </span>
    {% elif run and run.symbol %}
    <span class="badge bg-light text-dark border">
        <i class="bi bi-tag me-1"></i>{{ run.symbol }}
    </span>
    {% endif %}
    {% if run.completed_at %}
    <small class="text-muted">{{ run.completed_at[:19] }}</small>
    {% endif %}
</div>
{% endif %}

{# ── Symbol Switcher ─────────────────────────────────── #}
{% if run and symbol_runs and symbol_runs|length > 1 %}
<div class="d-flex align-items-center gap-2 flex-wrap mb-3">
    <small class="text-muted fw-bold">Symbol Runs:</small>
    {% for sym, sr in symbol_runs|dictsort %}
    {% set is_current = (sym == (run.symbol or default_symbol)) %}
    <a href="/run/{{ sr.run_id }}"
       class="btn btn-sm {{ 'btn-primary' if is_current else 'btn-outline-secondary' }}">
        {% if sym == '__ALL__' %}
        <i class="bi bi-collection me-1"></i>All
        {% else %}
        <i class="bi bi-tag me-1"></i>{{ sym }}
        {% endif %}
    </a>
    {% endfor %}
</div>
{% endif %}

{# ── No-Results Prompt (shown when user selects a symbol with no runs) ── #}
<div id="noResultsBanner" class="alert alert-info d-flex align-items-center d-none mb-3" role="alert">
    <i class="bi bi-info-circle-fill me-2"></i>
    <span id="noResultsText"></span>
    <button id="noResultsRunBtn" class="btn btn-warning btn-sm ms-auto">
        <i class="bi bi-play-fill me-1"></i>Run Backtest
    </button>
</div>

<div class="header-bar d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
    <div class="d-flex align-items-center gap-2 flex-wrap">
        <h5 class="fw-bold mb-0">
            {% if strategy and strategy.name %}
                {{ strategy.name }}
            {% else %}
                {{ filename }}
            {% endif %}
        </h5>
        {% if strategy and strategy.symbol %}
            <span class="badge bg-light text-dark border" style="font-size: 0.75rem;">
                <i class="bi bi-tag-fill me-1" style="font-size: 0.65rem;"></i>{{ strategy.symbol }}
            </span>
        {% endif %}
        {% if status == "approved" %}
            <span class="badge badge-approved">Approved</span>
        {% elif status == "rejected" %}
            <span class="badge badge-rejected">Rejected</span>
        {% elif status == "staged" %}
            <span class="badge badge-staged">Staged</span>
        {% else %}
            <span class="badge badge-pending">Pending</span>
        {% endif %}
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <form method="POST" action="/results/{{ filename }}/stage" class="d-inline">
            <button type="submit" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-up-circle me-1"></i>Stage
            </button>
        </form>
        <form method="POST" action="/results/{{ filename }}/approve" class="d-inline">
            <button type="submit" class="btn btn-outline-success btn-sm">
                <i class="bi bi-check-circle me-1"></i>Approve
            </button>
        </form>
        <form method="POST" action="/results/{{ filename }}/reject" class="d-inline">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-x-circle me-1"></i>Reject
            </button>
        </form>
        {% if db_configured %}
        <form method="POST" action="/backtest/run" class="d-inline d-flex gap-1 align-items-center">
            {% if run and run.strategy_id %}
            <input type="hidden" name="strategy_id" value="{{ run.strategy_id }}">
            {% endif %}
            {% if run and run.version_id %}
            <input type="hidden" name="version_id" value="{{ run.version_id }}">
            {% endif %}
            <select class="form-select form-select-sm" name="symbol" id="symbolSelectHeader"
                    data-symbol-selector
                    data-symbol-preselect="{{ run.symbol or '' if run else '' }}"
                    style="width: auto; max-width: 140px;">
                <option value="">{{ default_symbol }}</option>
                <option value="__ALL__" {% if run and run.symbol == '__ALL__' %}selected{% endif %}>All Symbols</option>
            </select>
            <button type="submit" class="btn btn-warning btn-sm">
                <i class="bi bi-play-fill me-1"></i>Run Backtest
            </button>
        </form>
        {% if run %}
        <form method="POST" action="/strategy/reverse" class="d-inline">
            <input type="hidden" name="run_id" value="{{ run.id }}">
            <button type="submit" class="btn btn-outline-info btn-sm">
                <i class="bi bi-arrow-repeat me-1"></i>Reverse Strategy
            </button>
        </form>
        {% endif %}
        {% endif %}
    </div>
</div>

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ROW 2 — Main Workbench (Two-Column)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
<div class="row g-3 mb-4">

    {# ── Left Column: AFL Editor ──────────────────────── #}
    <div class="col-lg-5">
        {% if afl_content is defined and afl_content is not none %}
        <div class="card workbench-card h-100">
            <div class="card-header d-flex align-items-center justify-content-between py-2">
                <span class="fw-semibold" style="font-size: 0.9rem;">
                    <i class="bi bi-code-slash me-1"></i>AFL Editor
                </span>
                {% if afl_path %}
                <small class="text-muted text-mono" style="font-size: 0.75rem;">
                    {{ afl_path.replace('\\', '/').split('/')[-1] }}
                </small>
                {% endif %}
            </div>
            <div class="card-body p-0">
                <form id="aflSaveForm" class="afl-form" method="POST" action="/afl/save">
                    <textarea name="afl_content" id="afl-code" style="display:none;">{{ afl_content }}</textarea>
                    <input type="hidden" name="redirect_to" value="/results/{{ filename }}">
                </form>
            </div>
            <div class="card-footer bg-white py-2">
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <button type="submit" form="aflSaveForm" class="btn btn-success btn-sm">
                        <i class="bi bi-save me-1"></i>Save &amp; Rebuild
                    </button>
                    <button type="button" id="btnSaveVersion" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-bookmark-plus me-1"></i>Save Version
                    </button>
                    {% if db_configured %}
                    <form method="POST" action="/backtest/run" class="afl-form d-inline d-flex gap-1 align-items-center">
                        <textarea name="afl_content" style="display:none;"></textarea>
                        <select class="form-select form-select-sm" name="symbol" id="symbolSelectAfl"
                                data-symbol-selector
                                data-symbol-preselect="{{ run.symbol or '' if run else '' }}"
                                style="width: auto; max-width: 130px;">
                            <option value="">{{ default_symbol }}</option>
                            <option value="__ALL__" {% if run and run.symbol == '__ALL__' %}selected{% endif %}>All</option>
                        </select>
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="bi bi-play-fill me-1"></i>Run
                        </button>
                    </form>
                    {% endif %}
                </div>
                <div id="versionLabelGroup" class="d-none mt-2">
                    <form class="afl-form" method="POST" action="/afl/save">
                        <textarea name="afl_content" style="display:none;"></textarea>
                        <input type="hidden" name="redirect_to" value="/results/{{ filename }}">
                        <input type="hidden" name="create_version" value="on">
                        <div class="input-group input-group-sm">
                            <input type="text" name="version_label" id="versionLabel"
                                   class="form-control"
                                   placeholder="Version label (e.g. 'added RSI filter')">
                            <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        {# ── Version History ──────────────────────────── #}
        {% if versions %}
        <div class="card mt-3 workbench-card">
            <div class="card-header py-2" data-bs-toggle="collapse" data-bs-target="#versionHistory"
                 role="button" aria-expanded="false" style="cursor: pointer;">
                <small class="fw-semibold">
                    <i class="bi bi-clock-history me-1"></i>Version History ({{ versions|length }})
                    <i class="bi bi-chevron-down float-end mt-1" style="font-size: 0.7rem;"></i>
                </small>
            </div>
            <div class="collapse" id="versionHistory">
                <div class="card-body p-0" style="max-height: 200px; overflow-y: auto;">
                    {% for v in versions %}
                    <div class="version-item d-flex align-items-center justify-content-between">
                        <div>
                            <span class="text-mono" style="font-size: 0.8rem;">{{ v.name }}</span>
                            {% if v.label %}
                                <span class="badge bg-light text-dark ms-1" style="font-size: 0.7rem;">{{ v.label }}</span>
                            {% endif %}
                            <br>
                            <small class="text-muted">{{ v.timestamp }}</small>
                        </div>
                        <div class="d-flex gap-1">
                            <button type="button" class="btn btn-outline-info btn-sm version-preview-btn"
                                    data-version-name="{{ v.name }}"
                                    style="font-size: 0.75rem; padding: 2px 8px;">
                                Preview
                            </button>
                            <form method="POST" action="/afl/versions/{{ v.name }}/load" class="d-inline">
                                <input type="hidden" name="redirect_to" value="/results/{{ filename }}">
                                <button type="submit" class="btn btn-outline-secondary btn-sm"
                                        style="font-size: 0.75rem; padding: 2px 8px;">
                                    Load
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% else %}
        {# No AFL content available #}
        <div class="card workbench-card">
            <div class="card-header py-2">
                <span class="fw-semibold" style="font-size: 0.9rem;">
                    <i class="bi bi-code-slash me-1"></i>AFL Editor
                </span>
            </div>
            <div class="card-body text-center py-4">
                <i class="bi bi-file-earmark-code text-muted" style="font-size: 2rem;"></i>
                <p class="text-muted small mt-2 mb-0">No AFL file loaded. <a href="/afl">Open editor</a></p>
            </div>
        </div>
        {% endif %}
    </div>

    {# ── Right Column: Content depends on optimization vs backtest ── #}
    <div class="col-lg-7">

    {% if is_optimization is defined and is_optimization %}
        {# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
           OPTIMIZATION RESULTS — Summary Metrics
           ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
        {% if parsed and not parsed.error %}
        {% set m = parsed.metrics %}
        <div class="card workbench-card mb-3">
            <div class="card-header py-2">
                <span class="fw-semibold" style="font-size: 0.9rem;">
                    <i class="bi bi-gear me-1"></i>Optimization Summary
                </span>
                <span class="badge bg-warning text-dark ms-2">Optimization</span>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    {% if m.combos_tested is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-blue">
                            <div class="metric-value">{{ m.combos_tested }}</div>
                            <div class="metric-label">Combos Tested</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if m.best_net_profit is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-green">
                            <div class="metric-value {% if m.best_net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.2f"|format(m.best_net_profit) }}
                            </div>
                            <div class="metric-label">Best Net Profit</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if m.worst_net_profit is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-red">
                            <div class="metric-value text-danger">
                                ${{ "%.2f"|format(m.worst_net_profit) }}
                            </div>
                            <div class="metric-label">Worst Net Profit</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if m.avg_net_profit is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-gray">
                            <div class="metric-value {% if m.avg_net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                                ${{ "%.2f"|format(m.avg_net_profit) }}
                            </div>
                            <div class="metric-label">Avg Net Profit</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if m.profitable_combos is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-green">
                            <div class="metric-value text-success">
                                {{ m.profitable_combos }}
                                {% if m.combos_tested is defined and m.combos_tested > 0 %}
                                <small class="text-muted" style="font-size: 0.7rem;">
                                    ({{ "%.0f"|format(m.profitable_combos / m.combos_tested * 100) }}%)
                                </small>
                                {% endif %}
                            </div>
                            <div class="metric-label">Profitable Combos</div>
                        </div>
                    </div>
                    {% endif %}

                    {% if m.avg_trades is defined %}
                    <div class="col-6 col-xl-3">
                        <div class="metric-card-sm border-blue">
                            <div class="metric-value">{{ m.avg_trades }}</div>
                            <div class="metric-label">Avg Trades/Combo</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# ── Optimization Net Profit Distribution Chart ── #}
        <div class="card workbench-card mb-3">
            <div class="card-header py-2">
                <span class="fw-semibold" style="font-size: 0.9rem;">
                    <i class="bi bi-bar-chart me-1"></i>Net Profit Distribution
                </span>
            </div>
            <div class="card-body">
                <canvas id="optDistChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        {% endif %}

        {% if parsed and parsed.error %}
            <div class="alert alert-danger mt-3 mb-0" style="font-size: 0.85rem; white-space: pre-wrap;">
                <i class="bi bi-exclamation-triangle me-1"></i>{{ parsed.error }}
            </div>
        {% endif %}

    {% else %}
        {# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
           BACKTEST RESULTS — Equity Curve + Metrics (original)
           ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
        {# ── Equity Curve Card ────────────────────────── #}
        <div class="card workbench-card mb-3">
            <div class="card-header d-flex align-items-center justify-content-between py-2">
                <span class="fw-semibold" style="font-size: 0.9rem;">
                    <i class="bi bi-graph-up me-1"></i>Equity Curve
                </span>
                <div class="toggle-pill btn-group" role="group">
                    <button type="button" class="btn active" id="btnTradeView">By Trade</button>
                    <button type="button" class="btn" id="btnTimeView">By Date</button>
                </div>
            </div>
            <div class="card-body">
                <div id="equityCurveError" class="d-none">
                    <div class="callout-amber">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        <span id="equityCurveErrorMsg">Unable to load equity curve data.</span>
                    </div>
                </div>
                <div id="equityCurveLoading" class="text-center py-4">
                    <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                    <p class="text-muted mt-2 mb-0" style="font-size: 0.85rem;">Loading equity curve...</p>
                </div>
                <canvas id="equityCurveChart" style="display:none; max-height: 320px;"></canvas>
            </div>
        </div>

        {# ── Trade Activity Bar Chart (time view only) ── #}
        <div id="activitySection" class="d-none mb-3">
            <div class="card workbench-card">
                <div class="card-header py-2">
                    <small class="fw-semibold">
                        <i class="bi bi-bar-chart me-1"></i>Trade Activity by Month
                    </small>
                </div>
                <div class="card-body py-2">
                    <canvas id="tradeActivityChart" style="max-height: 120px;"></canvas>
                </div>
            </div>
        </div>

        {# ── Summary Stats (time view only) ──────────── #}
        <div id="summarySection" class="d-none mb-3">
            <div class="row g-2">
                <div class="col">
                    <div class="card workbench-card">
                        <div class="card-body summary-stat py-2">
                            <div class="stat-value" id="summaryRange">--</div>
                            <div class="stat-label">Date Range</div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card workbench-card">
                        <div class="card-body summary-stat py-2">
                            <div class="stat-value" id="summaryDays">--</div>
                            <div class="stat-label">Total Days</div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card workbench-card">
                        <div class="card-body summary-stat py-2">
                            <div class="stat-value" id="summaryActiveDays">--</div>
                            <div class="stat-label">Active Days</div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card workbench-card">
                        <div class="card-body summary-stat py-2">
                            <div class="stat-value" id="summaryTradesMonth">--</div>
                            <div class="stat-label">Trades/Month</div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="card workbench-card">
                        <div class="card-body summary-stat py-2">
                            <div class="stat-value" id="summaryHolding">--</div>
                            <div class="stat-label">Avg Holding</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# ── Metrics Cards (2x4 grid) ────────────────── #}
        {% if parsed and not parsed.error %}
            {% set m = parsed.metrics if parsed.metrics is defined else parsed %}
            <div class="row g-2">
                {% if m.total_trades is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-blue">
                        <div class="metric-value">{{ m.total_trades }}</div>
                        <div class="metric-label">Total Trades</div>
                    </div>
                </div>
                {% endif %}

                {% if m.winning_trades is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-green">
                        <div class="metric-value text-success">{{ m.winning_trades }}</div>
                        <div class="metric-label">Wins</div>
                    </div>
                </div>
                {% endif %}

                {% if m.losing_trades is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-red">
                        <div class="metric-value text-danger">{{ m.losing_trades }}</div>
                        <div class="metric-label">Losses</div>
                    </div>
                </div>
                {% endif %}

                {% if m.win_rate is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-green">
                        <div class="metric-value">{{ m.win_rate }}{% if m.win_rate is number %}%{% endif %}</div>
                        <div class="metric-label">Win Rate</div>
                    </div>
                </div>
                {% endif %}

                {% if m.total_profit is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-green">
                        <div class="metric-value {% if m.total_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ m.total_profit }}
                        </div>
                        <div class="metric-label">Total Profit</div>
                    </div>
                </div>
                {% endif %}

                {% if m.avg_profit_per_trade is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-green">
                        <div class="metric-value {% if m.avg_profit_per_trade >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ m.avg_profit_per_trade }}
                        </div>
                        <div class="metric-label">Avg Profit</div>
                    </div>
                </div>
                {% endif %}

                {% if m.max_drawdown is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-red">
                        <div class="metric-value text-danger">{{ m.max_drawdown }}</div>
                        <div class="metric-label">Max Drawdown</div>
                    </div>
                </div>
                {% endif %}

                {% if m.long_trades is defined or m.short_trades is defined %}
                <div class="col-6 col-xl-3">
                    <div class="metric-card-sm border-gray">
                        <div class="metric-value">
                            {{ m.long_trades|default('--') }}
                            <span class="text-muted" style="font-size: 0.8rem;">/</span>
                            {{ m.short_trades|default('--') }}
                        </div>
                        <div class="metric-label">Long / Short</div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% endif %}

        {% if parsed and parsed.error %}
            <div class="alert alert-danger mt-3 mb-0" style="font-size: 0.85rem; white-space: pre-wrap;">
                <i class="bi bi-exclamation-triangle me-1"></i>{{ parsed.error }}
            </div>
        {% endif %}
    {% endif %}
    </div>
</div>

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ROW 3 — Results Table (Trade Log OR Optimization Combos)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
{% if parsed and parsed.trades %}

{% if is_optimization is defined and is_optimization %}
{# ── Optimization Results Table ──────────────────── #}
<div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between py-2"
         data-bs-toggle="collapse" data-bs-target="#optTableBody" role="button"
         aria-expanded="true" style="cursor: pointer;">
        <span>
            <i class="bi bi-table me-2"></i>Optimization Results
            <span class="badge bg-warning text-dark ms-2">{{ parsed.trades|length }} combinations</span>
        </span>
        <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
    </div>
    <div class="collapse show" id="optTableBody">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle mb-0"
                       id="optResultsTable" style="font-size: 0.82rem;">
                    <thead class="table-light">
                        <tr>
                            <th class="text-muted" style="width: 40px;">#</th>
                            {% for col in parsed.columns %}
                            <th class="opt-sortable" data-col="{{ col }}" style="cursor: pointer; user-select: none;"
                                title="Click to sort">
                                {{ col }}
                                <i class="bi bi-chevron-expand ms-1" style="font-size: 0.6rem; opacity: 0.4;"></i>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% set net_col = parsed.metrics.get("net_profit_column", "") if parsed.metrics is defined and parsed.metrics is mapping else "" %}
                        {% for combo in parsed.trades %}
                        <tr {% if loop.index == 1 and net_col %}class="table-success"{% endif %}>
                            <td class="text-muted">{{ loop.index }}</td>
                            {% for col in parsed.columns %}
                            <td {% if col == net_col %}
                                    {% set nv = combo[col]|float(0) %}
                                    class="fw-semibold {% if nv > 0 %}text-success{% elif nv < 0 %}text-danger{% endif %}"
                                {% endif %}>
                                {{ combo[col] }}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% else %}
{# ── Backtest Trade Table (original) ────────────── #}
<div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between py-2"
         data-bs-toggle="collapse" data-bs-target="#tradeTableBody" role="button"
         aria-expanded="true" style="cursor: pointer;">
        <span>
            <i class="bi bi-table me-2"></i>Trade Log
            <span class="badge bg-secondary ms-2">{{ parsed.trades|length }} trades</span>
        </span>
        <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
    </div>
    <div class="collapse show" id="tradeTableBody">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-striped table-hover align-middle mb-0"
                       id="btTradeTable" style="font-size: 0.85rem;">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            {% if parsed.columns is defined %}
                                {% for col in parsed.columns %}
                                <th class="bt-sortable" data-col="{{ col }}"
                                    style="cursor: pointer; user-select: none;"
                                    title="Click to sort · Double-click for stats">
                                    {{ col }}
                                    <i class="bi bi-chevron-expand ms-1" style="font-size: 0.6rem; opacity: 0.4;"></i>
                                </th>
                                {% endfor %}
                            {% else %}
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Entry Date</th>
                                <th>Entry Price</th>
                                <th>Exit Date</th>
                                <th>Exit Price</th>
                                <th>Shares</th>
                                <th class="text-end">Profit</th>
                                <th class="text-end">Cum. Profit</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in parsed.trades %}
                        {% if parsed.columns is defined %}
                            {# Dynamic columns from CSV #}
                            {% set profit_col = parsed.metrics.get("profit_column_used", None) if parsed.metrics is defined and parsed.metrics is mapping else None %}
                            {% if profit_col and trade.get(profit_col, "") != "" %}
                                {% set pval = trade[profit_col] | float(0) %}
                                {% if pval > 0 %}
                        <tr class="trade-win trade-row-clickable"
                                {% elif pval < 0 %}
                        <tr class="trade-loss trade-row-clickable"
                                {% else %}
                        <tr class="trade-row-clickable"
                                {% endif %}
                            {% else %}
                        <tr class="trade-row-clickable"
                            {% endif %}
                            data-symbol="{{ trade.get('Symbol', '') }}"
                            data-entry-date="{{ trade.get('Date', '') }}"
                            data-exit-date="{{ trade.get('Ex. date', '') }}"
                            data-entry-price="{{ trade.get('Price', '') }}"
                            data-exit-price="{{ trade.get('Ex. Price', '') }}"
                            data-trade-type="{{ trade.get('Trade', '') }}"
                            data-profit="{{ trade.get('Profit', '') }}"
                            data-trade-index="{{ loop.index }}">
                            <td class="text-muted">{{ loop.index }}</td>
                            {% for col in parsed.columns %}
                            <td>{{ trade[col] }}</td>
                            {% endfor %}
                        </tr>
                        {% else %}
                            {# Structured trade objects #}
                            {% set profit = trade.profit|default(0)|float %}
                        <tr class="trade-row-clickable {{ 'trade-win' if profit > 0 else ('trade-loss' if profit < 0 else '') }}"
                            data-symbol="{{ trade.symbol|default('') }}"
                            data-entry-date="{{ trade.entry_date|default('') }}"
                            data-exit-date="{{ trade.exit_date|default('') }}"
                            data-entry-price="{{ trade.entry_price|default('') }}"
                            data-exit-price="{{ trade.exit_price|default('') }}"
                            data-trade-type="{{ trade.type|default('') }}"
                            data-profit="{{ trade.profit|default('') }}"
                            data-trade-index="{{ loop.index }}">
                            <td class="text-muted">{{ loop.index }}</td>
                            <td class="fw-semibold">{{ trade.symbol|default('--') }}</td>
                            <td>
                                {% if trade.type is defined %}
                                    {% if trade.type|lower == 'long' %}
                                        <span class="badge bg-primary bg-opacity-10 text-primary">Long</span>
                                    {% elif trade.type|lower == 'short' %}
                                        <span class="badge bg-warning bg-opacity-10 text-warning">Short</span>
                                    {% else %}
                                        {{ trade.type }}
                                    {% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>{{ trade.entry_date|default('--') }}</td>
                            <td>{{ trade.entry_price|default('--') }}</td>
                            <td>{{ trade.exit_date|default('--') }}</td>
                            <td>{{ trade.exit_price|default('--') }}</td>
                            <td>{{ trade.shares|default('--') }}</td>
                            <td class="text-end fw-semibold {{ 'text-success' if profit > 0 else ('text-danger' if profit < 0 else '') }}">
                                {% if trade.profit is defined %}
                                    {{ '%.2f'|format(trade.profit|float) }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if trade.cum_profit is defined %}
                                    {{ '%.2f'|format(trade.cum_profit|float) }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endif %}

{# ── Column Statistics Modal ────────────── #}
<div class="modal fade" id="colStatsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="colStatsTitle">Column Statistics</h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-sm table-borderless mb-3" style="font-size: 0.85rem;">
                    <tbody id="colStatsBody"></tbody>
                </table>
                <div style="height: 200px;">
                    <canvas id="colStatsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ROW 4 — Strategy Description (Collapsed by Default)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
{% if strategy %}
<div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between py-2"
         data-bs-toggle="collapse" data-bs-target="#strategyInfo" role="button"
         aria-expanded="false" style="cursor: pointer;">
        <span style="font-size: 0.9rem;">
            <i class="bi bi-info-circle me-2"></i>Strategy Information
        </span>
        <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
    </div>
    <div class="collapse" id="strategyInfo">
        <div class="card-body">
            <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                <h5 class="fw-bold mb-0">{{ strategy.name }}</h5>
                {% if strategy.symbol %}
                    <span class="badge bg-light text-dark border">
                        <i class="bi bi-tag me-1"></i>{{ strategy.symbol }}
                    </span>
                {% endif %}
            </div>

            {% if strategy.summary %}
                <p class="fst-italic text-muted mb-3">{{ strategy.summary }}</p>
            {% endif %}

            {% if strategy.description %}
                <div class="mb-3">
                    {% for para in strategy.description.split('\n') %}
                        {% if para.strip() %}
                            <p class="mb-2" style="font-size: 0.9rem;">{{ para }}</p>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}

            {% if strategy.parameters %}
            <div class="mb-3">
                <a class="fw-semibold text-decoration-none" data-bs-toggle="collapse"
                   href="#strategyParams" role="button" aria-expanded="true" style="font-size: 0.9rem;">
                    <i class="bi bi-sliders me-1"></i>Parameters
                    <i class="bi bi-chevron-down small ms-1"></i>
                </a>
                <div class="collapse show mt-2" id="strategyParams">
                    <table class="table table-sm table-bordered mb-0" style="max-width: 500px; font-size: 0.85rem;">
                        <thead class="table-light">
                            <tr><th>Parameter</th><th>Value</th></tr>
                        </thead>
                        <tbody>
                            {% if strategy.parameters is mapping %}
                                {% for key, val in strategy.parameters.items() %}
                                <tr>
                                    <td class="fw-semibold text-mono">{{ key }}</td>
                                    <td>{{ val }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                {% for param in strategy.parameters %}
                                <tr>
                                    <td class="fw-semibold text-mono">{{ param.name }}</td>
                                    <td>{{ param.value }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            {% if strategy.risk_notes %}
            <div class="callout-amber">
                <i class="bi bi-shield-exclamation me-1"></i>
                <strong>Risk Notes:</strong> {{ strategy.risk_notes }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ROW 5 — Download Links / Navigation
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
<div class="d-flex flex-wrap gap-2 mb-4">
    <a href="/" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i>Back to Dashboard
    </a>
    <a href="/results/{{ filename }}/download" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-download me-1"></i>Download CSV
    </a>
    {% if has_html %}
    <a href="/results/{{ filename.replace('.csv', '.html') }}/download" class="btn btn-outline-info btn-sm" target="_blank">
        <i class="bi bi-filetype-html me-1"></i>View HTML Report
    </a>
    {% endif %}
</div>

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Version Preview Modal
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
<div class="modal fade" id="versionPreviewModal" tabindex="-1" aria-labelledby="versionPreviewLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="versionPreviewLabel">
                    <i class="bi bi-eye me-1"></i>Version Preview
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="versionPreviewBody">
                <div class="text-center py-4" id="versionPreviewLoading">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <p class="text-muted small mt-2 mb-0">Loading version...</p>
                </div>
                <pre id="versionPreviewCode" class="mb-0" style="display:none; border-radius: 0; border: none; max-height: 500px;"></pre>
                <div id="versionPreviewError" class="d-none p-3">
                    <div class="callout-amber">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        <span id="versionPreviewErrorMsg">Unable to load version.</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   Candlestick Chart Modal (Sprint 3)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ #}
<div class="modal fade" id="candlestickModal" tabindex="-1" aria-labelledby="candlestickModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h6 class="modal-title" id="candlestickModalLabel">
                    <i class="bi bi-bar-chart-line me-1"></i>
                    Trade Chart: <span id="chartTradeTitle">--</span>
                </h6>
                <button type="button" class="btn-close btn-close-sm" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                {# Trade summary row #}
                <div class="px-3 py-2 border-bottom bg-light d-flex flex-wrap gap-3" style="font-size: 0.85rem;">
                    <span><strong>Direction:</strong> <span id="chartDirection">--</span></span>
                    <span><strong>Entry:</strong> <span id="chartEntryInfo">--</span></span>
                    <span><strong>Exit:</strong> <span id="chartExitInfo">--</span></span>
                    <span><strong>P&amp;L:</strong> <span id="chartPnL">--</span></span>
                </div>
                {# Timeframe selector (Sprint 4) #}
                <div class="px-3 py-1 border-bottom d-flex align-items-center gap-2" style="font-size: 0.8rem;">
                    <span class="text-muted fw-semibold me-1">Timeframe:</span>
                    <div class="btn-group btn-group-sm" role="group" id="tfSelector">
                        <button type="button" class="btn btn-outline-secondary active" data-interval="60">1m</button>
                        <button type="button" class="btn btn-outline-secondary" data-interval="300">5m</button>
                        <button type="button" class="btn btn-outline-secondary" data-interval="600">10m</button>
                        <button type="button" class="btn btn-outline-secondary" data-interval="86400">D</button>
                    </div>
                </div>
                {# Strategy indicator toggles #}
                <div class="px-3 py-1 border-bottom d-flex align-items-center flex-wrap gap-2" style="font-size: 0.8rem;">
                    <span class="text-muted fw-semibold me-1">Indicators:</span>
                    <div class="d-flex gap-2 flex-wrap" id="indicatorToggles">
                        {% for cfg in indicator_configs %}
                        <div class="form-check form-check-inline form-switch mb-0">
                            <input class="form-check-input indicator-toggle" type="checkbox" checked
                                   id="indCfg{{ loop.index }}"
                                   data-type="{{ cfg.type }}"
                                   data-params='{{ cfg.params | tojson }}'
                                   data-overlay='{{ cfg.overlay | tojson }}'
                                   data-color="{{ cfg.color }}">
                            <label class="form-check-label" for="indCfg{{ loop.index }}" style="font-size: 0.78rem;">
                                <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:{{ cfg.color }};margin-right:3px;vertical-align:middle;"></span>{{ cfg.type | upper }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {# Chart area with data tooltip #}
                <div style="position:relative;">
                    <div class="trade-data-tooltip" id="tradeDataTooltip"></div>
                    {# Main chart container #}
                    <div id="candlestickChartContainer">
                        <div class="chart-loading-overlay" id="chartLoading">
                            <div class="text-center">
                                <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
                                <p class="text-muted mt-2 mb-0" style="font-size: 0.85rem;">Loading chart data from AmiBroker...</p>
                            </div>
                        </div>
                    </div>
                    {# Sub-pane for non-overlay indicators (RSI, ADX, etc.) #}
                    <div id="tradeSubPaneCard" style="display:none; border-top:1px solid #e9ecef;">
                        <div style="position:relative;">
                            <span class="text-muted" id="tradeSubPaneLabel"
                                  style="position:absolute;top:4px;left:8px;font-size:0.7rem;z-index:2;"></span>
                            <div id="tradeSubPaneChart" style="height:150px;"></div>
                        </div>
                    </div>
                </div>
                {# Error state #}
                <div id="chartError" class="d-none p-3">
                    <div class="callout-amber">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        <span id="chartErrorMsg">Unable to load chart data.</span>
                    </div>
                </div>
            </div>
            {# Run context for JS (Sprint 4) #}
            {% if run %}
            <div id="runContext" data-run-id="{{ run.id }}" data-version-id="{{ run.version_id }}" style="display:none;"></div>
            {% endif %}
            <div class="modal-footer py-2">
                <small class="text-muted me-auto" id="chartIntervalLabel">1-min candlestick data from AmiBroker database</small>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/* Symbol runs map: symbol -> {run_id, symbol} for completed sibling runs */
const symbolRunsMap = {{ (symbol_runs or {}) | tojson }};
const currentRunSymbol = {{ ((run.symbol if run else '') or (default_symbol if default_symbol is defined else '')) | tojson }};

document.addEventListener('DOMContentLoaded', function() {

    /* ═══════════════════════════════════════════════════════
       SYMBOL SWITCHER — Navigate to results for selected symbol
       ═══════════════════════════════════════════════════════ */
    (function() {
        var symbolSelect = document.getElementById('symbolSelectHeader');
        var noResultsBanner = document.getElementById('noResultsBanner');
        var noResultsText = document.getElementById('noResultsText');
        var noResultsRunBtn = document.getElementById('noResultsRunBtn');
        if (!symbolSelect) return;

        symbolSelect.addEventListener('change', function() {
            var sym = this.value || currentRunSymbol;
            if (noResultsBanner) noResultsBanner.classList.add('d-none');

            // Same symbol as current run — do nothing
            if (sym === currentRunSymbol) return;

            if (symbolRunsMap[sym]) {
                // Completed run exists for this symbol — navigate to it
                window.location.href = '/run/' + symbolRunsMap[sym].run_id;
            } else {
                // No results for this symbol — show prompt
                if (noResultsText) {
                    noResultsText.textContent = '\u201c' + sym + '\u201d has no results. Would you like to run a backtest?';
                    noResultsBanner.classList.remove('d-none');
                }
            }
        });

        // "Run Backtest" button in the no-results banner reuses the existing form
        if (noResultsRunBtn) {
            noResultsRunBtn.addEventListener('click', function() {
                var form = symbolSelect.closest('form');
                if (form) form.submit();
            });
        }
    })();

    /* ═══════════════════════════════════════════════════════
       OPTIMIZATION — Distribution Chart + Table Sort
       ═══════════════════════════════════════════════════════ */
    {% if is_optimization is defined and is_optimization and parsed and parsed.trades %}
    (function() {
        // --- Net Profit Distribution Chart ---
        var distCanvas = document.getElementById('optDistChart');
        if (distCanvas) {
            var profits = [];
            var netProfitCol = {{ (parsed.metrics.get("net_profit_column", "")|tojson) }};
            {% for combo in parsed.trades %}
            {% if parsed.metrics.get("net_profit_column", "") %}
            profits.push(parseFloat({{ combo[parsed.metrics.get("net_profit_column", "Net Profit")]|default(0)|tojson }}) || 0);
            {% endif %}
            {% endfor %}

            if (profits.length > 0) {
                // Build histogram bins
                var minP = Math.min.apply(null, profits);
                var maxP = Math.max.apply(null, profits);
                var range = maxP - minP;
                var binCount = Math.min(20, Math.max(5, Math.ceil(Math.sqrt(profits.length))));
                var binSize = range / binCount || 1;
                var bins = [];
                var labels = [];
                for (var b = 0; b < binCount; b++) {
                    bins.push(0);
                    var lo = minP + b * binSize;
                    var hi = lo + binSize;
                    labels.push('$' + Math.round(lo).toLocaleString());
                }
                profits.forEach(function(p) {
                    var idx = Math.min(Math.floor((p - minP) / binSize), binCount - 1);
                    if (idx < 0) idx = 0;
                    bins[idx]++;
                });

                new Chart(distCanvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Combinations',
                            data: bins,
                            backgroundColor: bins.map(function(_, i) {
                                var midVal = minP + (i + 0.5) * binSize;
                                return midVal >= 0 ? 'rgba(25, 135, 84, 0.6)' : 'rgba(220, 53, 69, 0.6)';
                            }),
                            borderRadius: 3,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Count', font: { size: 11 } },
                                ticks: { stepSize: 1, font: { size: 10 } }
                            },
                            x: {
                                title: { display: true, text: 'Net Profit', font: { size: 11 } },
                                ticks: { font: { size: 9 }, maxRotation: 45 }
                            }
                        }
                    }
                });
            }
        }

        // --- Table Sorting ---
        var optTable = document.getElementById('optResultsTable');
        if (optTable) {
            var sortDir = {};
            optTable.querySelectorAll('.opt-sortable').forEach(function(th) {
                th.addEventListener('click', function() {
                    var col = this.dataset.col;
                    var colIdx = Array.from(this.parentNode.children).indexOf(this);
                    var tbody = optTable.querySelector('tbody');
                    var rows = Array.from(tbody.querySelectorAll('tr'));

                    sortDir[col] = sortDir[col] === 'asc' ? 'desc' : 'asc';
                    var dir = sortDir[col];

                    rows.sort(function(a, b) {
                        var aVal = a.children[colIdx].textContent.trim();
                        var bVal = b.children[colIdx].textContent.trim();
                        var aNum = parseFloat(aVal);
                        var bNum = parseFloat(bVal);
                        if (!isNaN(aNum) && !isNaN(bNum)) {
                            return dir === 'asc' ? aNum - bNum : bNum - aNum;
                        }
                        return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    });

                    // Re-number and re-append
                    rows.forEach(function(row, i) {
                        row.children[0].textContent = i + 1;
                        // Highlight best row (first row when sorted by profit desc)
                        row.classList.remove('table-success');
                        tbody.appendChild(row);
                    });
                    if (dir === 'desc') {
                        rows[0].classList.add('table-success');
                    }

                    // Update sort icons
                    optTable.querySelectorAll('.opt-sortable i').forEach(function(icon) {
                        icon.className = 'bi bi-chevron-expand ms-1';
                        icon.style.opacity = '0.4';
                    });
                    var icon = this.querySelector('i');
                    icon.className = dir === 'asc' ? 'bi bi-chevron-up ms-1' : 'bi bi-chevron-down ms-1';
                    icon.style.opacity = '1';
                });
            });
        }
    })();
    {% endif %}

    /* ═══════════════════════════════════════════════════════
       BACKTEST TABLE — Sorting & Column Statistics
       ═══════════════════════════════════════════════════════ */
    (function() {
        var btTable = document.getElementById('btTradeTable');
        if (!btTable) return;

        // --- Sorting (single-click) ---
        var btSortDir = {};
        btTable.querySelectorAll('.bt-sortable').forEach(function(th) {
            th.addEventListener('click', function() {
                var col = this.dataset.col;
                var colIdx = Array.from(this.parentNode.children).indexOf(this);
                var tbody = btTable.querySelector('tbody');
                var rows = Array.from(tbody.querySelectorAll('tr'));

                btSortDir[col] = btSortDir[col] === 'asc' ? 'desc' : 'asc';
                var dir = btSortDir[col];

                rows.sort(function(a, b) {
                    var aVal = a.children[colIdx] ? a.children[colIdx].textContent.trim() : '';
                    var bVal = b.children[colIdx] ? b.children[colIdx].textContent.trim() : '';
                    var aNum = parseFloat(aVal);
                    var bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return dir === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                    return dir === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                });

                rows.forEach(function(row, i) {
                    row.children[0].textContent = i + 1;
                    tbody.appendChild(row);
                });

                // Update sort icons
                btTable.querySelectorAll('.bt-sortable i').forEach(function(icon) {
                    icon.className = 'bi bi-chevron-expand ms-1';
                    icon.style.opacity = '0.4';
                });
                var icon = this.querySelector('i');
                icon.className = dir === 'asc' ? 'bi bi-chevron-up ms-1' : 'bi bi-chevron-down ms-1';
                icon.style.opacity = '1';
            });

            // --- Column Statistics (double-click) ---
            th.addEventListener('dblclick', function(e) {
                e.preventDefault();
                var col = this.dataset.col;
                var colIdx = Array.from(this.parentNode.children).indexOf(this);
                var tbody = btTable.querySelector('tbody');
                var rows = Array.from(tbody.querySelectorAll('tr'));

                // Collect numeric values from this column
                var values = [];
                rows.forEach(function(row) {
                    var cell = row.children[colIdx];
                    if (cell) {
                        var v = parseFloat(cell.textContent.trim());
                        if (!isNaN(v)) values.push(v);
                    }
                });

                if (values.length === 0) return;

                // Compute stats
                var sorted = values.slice().sort(function(a, b) { return a - b; });
                var count = values.length;
                var sum = values.reduce(function(a, b) { return a + b; }, 0);
                var mean = sum / count;
                var median = count % 2 === 0
                    ? (sorted[count / 2 - 1] + sorted[count / 2]) / 2
                    : sorted[Math.floor(count / 2)];
                var min = sorted[0];
                var max = sorted[count - 1];
                var variance = values.reduce(function(acc, v) { return acc + (v - mean) * (v - mean); }, 0) / count;
                var stdDev = Math.sqrt(variance);

                // Build stats table
                var statsHtml = [
                    ['Count', count],
                    ['Mean', mean.toFixed(4)],
                    ['Median', median.toFixed(4)],
                    ['Min', min.toFixed(4)],
                    ['Max', max.toFixed(4)],
                    ['Std Dev', stdDev.toFixed(4)]
                ].map(function(r) {
                    return '<tr><td class="text-muted" style="width:40%;">' + r[0] + '</td><td class="fw-semibold">' + r[1] + '</td></tr>';
                }).join('');
                document.getElementById('colStatsTitle').textContent = col + ' — Statistics';
                document.getElementById('colStatsBody').innerHTML = statsHtml;

                // Build histogram
                var canvas = document.getElementById('colStatsChart');
                var numBins = Math.min(15, Math.max(5, Math.ceil(Math.sqrt(count))));
                var binWidth = (max - min) / numBins || 1;
                var bins = new Array(numBins).fill(0);
                var binLabels = [];
                for (var b = 0; b < numBins; b++) {
                    var lo = min + b * binWidth;
                    var hi = lo + binWidth;
                    binLabels.push(lo.toFixed(2));
                    values.forEach(function(v) {
                        if (b === numBins - 1 ? (v >= lo && v <= hi) : (v >= lo && v < hi)) bins[b]++;
                    });
                }

                // Destroy previous chart instance if any
                if (window._colStatsChartInstance) {
                    window._colStatsChartInstance.destroy();
                }
                window._colStatsChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: [{
                            label: 'Frequency',
                            data: bins,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 10 } } },
                            x: { ticks: { font: { size: 9 }, maxRotation: 45 } }
                        }
                    }
                });

                var modal = new bootstrap.Modal(document.getElementById('colStatsModal'));
                modal.show();
            });
        });
    })();

    /* ═══════════════════════════════════════════════════════
       EQUITY CURVE — Dual-Mode Chart (backtest only)
       ═══════════════════════════════════════════════════════ */
    {% if not (is_optimization is defined and is_optimization) %}
    var chartInstance = null;
    var chartData = null;
    var canvasEl = document.getElementById('equityCurveChart');
    var ctx = canvasEl ? canvasEl.getContext('2d') : null;
    var activityCtx = document.getElementById('tradeActivityChart');
    var activityChart = null;

    var btnTrade = document.getElementById('btnTradeView');
    var btnTime = document.getElementById('btnTimeView');
    var activitySection = document.getElementById('activitySection');
    var summarySection = document.getElementById('summarySection');

    // Fetch equity curve data — use run-specific API for GUID-based runs
    var equityCurveUrl = {% if run %}'/api/run/{{ run.id }}/equity-curve'{% else %}'/api/results/{{ filename }}/equity-curve'{% endif %};
    fetch(equityCurveUrl)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            document.getElementById('equityCurveLoading').style.display = 'none';

            if (data.error) {
                document.getElementById('equityCurveErrorMsg').textContent = data.error;
                document.getElementById('equityCurveError').classList.remove('d-none');
                return;
            }

            chartData = data;
            canvasEl.style.display = 'block';

            // Default to trade view
            renderTradeView();

            // Populate summary stats if available
            if (data.summary && data.summary.date_range) {
                document.getElementById('summaryRange').textContent = data.summary.date_range;
                document.getElementById('summaryDays').textContent = data.summary.total_days;
                document.getElementById('summaryActiveDays').textContent = data.summary.active_trading_days;
                document.getElementById('summaryTradesMonth').textContent = data.summary.trades_per_month;
                document.getElementById('summaryHolding').textContent = data.summary.avg_holding_period_bars + ' bars';
            }
        })
        .catch(function(err) {
            document.getElementById('equityCurveLoading').style.display = 'none';
            document.getElementById('equityCurveErrorMsg').textContent = 'Failed to load equity curve: ' + err.message;
            document.getElementById('equityCurveError').classList.remove('d-none');
        });

    // Toggle handlers
    btnTrade.addEventListener('click', function() {
        btnTrade.classList.add('active');
        btnTime.classList.remove('active');
        activitySection.classList.add('d-none');
        summarySection.classList.add('d-none');
        if (chartData) renderTradeView();
    });

    btnTime.addEventListener('click', function() {
        btnTime.classList.add('active');
        btnTrade.classList.remove('active');
        activitySection.classList.remove('d-none');
        summarySection.classList.remove('d-none');
        if (chartData) renderTimeView();
    });

    function renderTradeView() {
        if (chartInstance) chartInstance.destroy();
        // Support both new (trade_view) and legacy (flat) API responses
        var tv = chartData.trade_view || chartData;
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: tv.labels,
                datasets: [{
                    label: 'Equity ($)',
                    data: tv.equity,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59,130,246,0.08)',
                    fill: true,
                    tension: 0.15,
                    pointBackgroundColor: tv.colors,
                    pointBorderColor: tv.colors,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    borderWidth: 2
                }]
            },
            options: chartOptions('Trade #', tv.dates || [], tv.profits || [])
        });
    }

    function renderTimeView() {
        if (chartInstance) chartInstance.destroy();
        var tv = chartData.time_view;
        if (!tv || !tv.dates || tv.dates.length === 0) {
            document.getElementById('equityCurveErrorMsg').textContent = 'No date data available for time view.';
            document.getElementById('equityCurveError').classList.remove('d-none');
            return;
        }
        document.getElementById('equityCurveError').classList.add('d-none');

        // Main equity line + trade markers as scatter overlay
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: tv.dates,
                datasets: [
                    {
                        label: 'Equity ($)',
                        data: tv.equity,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59,130,246,0.06)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        borderWidth: 2
                    },
                    {
                        label: 'Trades',
                        data: tv.trade_dates.map(function(d, i) {
                            return { x: d, y: tv.trade_equities[i] };
                        }),
                        type: 'scatter',
                        pointBackgroundColor: tv.trade_colors,
                        pointBorderColor: tv.trade_colors,
                        pointRadius: 7,
                        pointHoverRadius: 10,
                        showLine: false
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'nearest', intersect: true },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15,23,42,0.95)',
                        titleFont: { size: 12 },
                        bodyFont: { size: 11 },
                        padding: 10,
                        callbacks: {
                            label: function(context) {
                                if (context.datasetIndex === 1) {
                                    var i = context.dataIndex;
                                    var p = tv.trade_profits[i];
                                    var sign = p >= 0 ? '+' : '';
                                    return 'Trade: $' + context.parsed.y.toLocaleString() + ' (' + sign + '$' + p.toLocaleString() + ')';
                                }
                                return 'Equity: $' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'Equity ($)', font: { size: 11 } },
                        ticks: { callback: function(v) { return '$' + v.toLocaleString(); }, font: { size: 10 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        title: { display: true, text: 'Date', font: { size: 11 } },
                        ticks: { maxTicksLimit: 12, font: { size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });

        // Render trade activity bar chart
        renderActivityChart(tv);
    }

    function renderActivityChart(tv) {
        if (activityChart) activityChart.destroy();
        if (!activityCtx) return;

        // Aggregate trade counts by month
        var monthMap = {};
        tv.trade_dates.forEach(function(d) {
            var month = d.substring(0, 7); // YYYY-MM
            monthMap[month] = (monthMap[month] || 0) + 1;
        });
        var months = Object.keys(monthMap).sort();
        var counts = months.map(function(m) { return monthMap[m]; });

        activityChart = new Chart(activityCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Trades',
                    data: counts,
                    backgroundColor: 'rgba(59,130,246,0.6)',
                    borderRadius: 3
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, font: { size: 10 } },
                        title: { display: true, text: 'Trades', font: { size: 10 } }
                    },
                    x: {
                        ticks: { font: { size: 10 } },
                        grid: { display: false }
                    }
                }
            }
        });
    }

    function chartOptions(xLabel, dates, profits) {
        return {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15,23,42,0.95)',
                    titleFont: { size: 12 },
                    bodyFont: { size: 11 },
                    padding: 10,
                    callbacks: {
                        title: function(items) {
                            var i = items[0].dataIndex;
                            var d = dates[i];
                            return d ? items[0].label + ' \u2014 ' + d : items[0].label;
                        },
                        label: function(context) {
                            var p = profits[context.dataIndex];
                            var eq = context.parsed.y;
                            if (context.dataIndex === 0) {
                                return 'Starting Equity: $' + eq.toLocaleString();
                            }
                            var sign = p >= 0 ? '+' : '';
                            return 'Equity: $' + eq.toLocaleString() + '  (' + sign + '$' + p.toLocaleString() + ')';
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Equity ($)', font: { size: 11 } },
                    ticks: { callback: function(v) { return '$' + v.toLocaleString(); }, font: { size: 10 } },
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: {
                    title: { display: true, text: xLabel, font: { size: 11 } },
                    ticks: { font: { size: 10 } },
                    grid: { display: false }
                }
            }
        };
    }

    {% endif %}{# end backtest-only equity curve block #}

    /* ═══════════════════════════════════════════════════════
       CODEMIRROR — AFL Editor Setup
       ═══════════════════════════════════════════════════════ */
    var editorEl = document.getElementById('afl-code');
    if (editorEl) {
        var editor = CodeMirror.fromTextArea(editorEl, {
            mode: 'text/x-csrc',
            theme: 'dracula',
            lineNumbers: true,
            matchBrackets: true,
            styleActiveLine: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: false
        });
        editor.setSize(null, 420);

        // Sync editor content to all afl_content fields on any form submit
        document.querySelectorAll('form.afl-form').forEach(function(form) {
            form.addEventListener('submit', function() {
                editor.save();
                var content = editor.getValue();
                document.querySelectorAll('input[name="afl_content"], textarea[name="afl_content"]').forEach(function(el) {
                    el.value = content;
                });
            });
        });

        // Ctrl+S / Cmd+S keyboard shortcut to save
        editor.setOption('extraKeys', {
            'Ctrl-S': function() {
                editor.save();
                var content = editor.getValue();
                document.querySelectorAll('textarea[name="afl_content"]').forEach(function(el) {
                    el.value = content;
                });
                document.getElementById('aflSaveForm').submit();
            },
            'Cmd-S': function() {
                editor.save();
                var content = editor.getValue();
                document.querySelectorAll('textarea[name="afl_content"]').forEach(function(el) {
                    el.value = content;
                });
                document.getElementById('aflSaveForm').submit();
            }
        });

        // Version label toggle
        var versionBtn = document.getElementById('btnSaveVersion');
        var versionInput = document.getElementById('versionLabelGroup');
        if (versionBtn && versionInput) {
            versionBtn.addEventListener('click', function() {
                versionInput.classList.toggle('d-none');
                if (!versionInput.classList.contains('d-none')) {
                    document.getElementById('versionLabel').focus();
                }
            });
        }
    }

    {% if not (is_optimization is defined and is_optimization) %}
    /* ═══════════════════════════════════════════════════════
       TRADE CHART — Strategy-linked indicators with sub-pane
       ═══════════════════════════════════════════════════════ */
    var strategyIndicatorConfigs = {{ indicator_configs | tojson }};
    var candlestickChart = null;
    var tradeSubPaneChart = null;
    var tradeCandleSeries = null;
    var tradeVolumeSeries = null;
    var tradeMainSeries = {};
    var tradeSubPaneSeries = {};
    var candlestickModal = null;
    var currentTradeContext = null;
    var currentInterval = 60;
    var tradeTooltipState = { time: null, ohlc: null, volume: null, mainItems: [], subItems: [] };

    var INTERVAL_LABELS = {60: '1-min', 300: '5-min', 600: '10-min', 86400: 'Daily'};

    function fmtPrice(v) { return v != null ? v.toFixed(2) : '--'; }
    function fmtNum(v) { return v != null ? v.toFixed(2) : '--'; }
    function fmtVol(v) {
        if (v == null) return '--';
        if (v >= 1e6) return (v / 1e6).toFixed(1) + 'M';
        if (v >= 1e3) return (v / 1e3).toFixed(1) + 'K';
        return v.toString();
    }
    function escHtml(s) {
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(s));
        return d.innerHTML;
    }

    // --- Trade row click handler ---
    document.querySelectorAll('.trade-row-clickable').forEach(function(row) {
        row.addEventListener('click', function(e) {
            if (e.target.closest('a, button')) return;
            var symbol = this.dataset.symbol;
            var entryDate = this.dataset.entryDate;
            var exitDate = this.dataset.exitDate;
            var entryPrice = parseFloat(this.dataset.entryPrice);
            var exitPrice = parseFloat(this.dataset.exitPrice);
            var tradeType = this.dataset.tradeType;
            var tradeIndex = this.dataset.tradeIndex;
            var profit = parseFloat(this.dataset.profit) || 0;
            if (!symbol || !entryDate || !exitDate) return;
            showCandlestickChart(symbol, entryDate, exitDate, entryPrice, exitPrice, tradeType, tradeIndex, profit);
        });
    });

    // --- Timeframe selector ---
    document.querySelectorAll('#tfSelector .btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var interval = parseInt(this.dataset.interval);
            currentInterval = interval;
            document.querySelectorAll('#tfSelector .btn').forEach(function(b) { b.classList.remove('active'); });
            this.classList.add('active');
            loadChartData(interval);
        });
    });

    // --- Indicator toggle handlers ---
    document.querySelectorAll('.indicator-toggle').forEach(function(toggle) {
        toggle.addEventListener('change', function() {
            loadChartData(currentInterval);
        });
    });

    function getActiveIndicators() {
        var indicators = [];
        document.querySelectorAll('.indicator-toggle:checked').forEach(function(el) {
            indicators.push({
                type: el.dataset.type,
                params: JSON.parse(el.dataset.params),
                overlay: el.dataset.overlay === 'true',
                color: el.dataset.color || '#FF6D00'
            });
        });
        return indicators;
    }

    function showCandlestickChart(symbol, entryDate, exitDate, entryPrice, exitPrice, tradeType, tradeIndex, profit) {
        currentTradeContext = {
            symbol: symbol, entryDate: entryDate, exitDate: exitDate,
            entryPrice: entryPrice, exitPrice: exitPrice,
            tradeType: tradeType, tradeIndex: tradeIndex, profit: profit
        };
        currentInterval = 60;

        if (!candlestickModal) {
            candlestickModal = new bootstrap.Modal(document.getElementById('candlestickModal'));
        }

        document.getElementById('chartTradeTitle').textContent = symbol + ' \u2014 Trade #' + tradeIndex;
        document.getElementById('chartDirection').textContent = tradeType;
        document.getElementById('chartEntryInfo').textContent = entryPrice.toFixed(1) + ' @ ' + entryDate;
        document.getElementById('chartExitInfo').textContent = exitPrice.toFixed(1) + ' @ ' + exitDate;

        var pnlEl = document.getElementById('chartPnL');
        pnlEl.textContent = (profit >= 0 ? '+' : '') + profit.toFixed(2);
        pnlEl.className = profit >= 0 ? 'text-success fw-bold' : 'text-danger fw-bold';

        document.querySelectorAll('#tfSelector .btn').forEach(function(b) {
            b.classList.toggle('active', b.dataset.interval === '60');
        });

        candlestickModal.show();
        loadChartData(60);
    }

    function loadChartData(interval) {
        var ctx = currentTradeContext;
        if (!ctx) return;

        var container = document.getElementById('candlestickChartContainer');
        if (candlestickChart) { candlestickChart.remove(); candlestickChart = null; }
        if (tradeSubPaneChart) { tradeSubPaneChart.remove(); tradeSubPaneChart = null; }
        tradeMainSeries = {};
        tradeSubPaneSeries = {};
        document.getElementById('tradeSubPaneCard').style.display = 'none';
        document.getElementById('tradeDataTooltip').classList.remove('visible');

        var loadingEl = document.getElementById('chartLoading');
        container.innerHTML = '';
        container.appendChild(loadingEl);
        loadingEl.style.display = 'flex';
        document.getElementById('chartError').classList.add('d-none');

        document.getElementById('chartIntervalLabel').textContent =
            (INTERVAL_LABELS[interval] || interval + 's') + ' candlestick data from AmiBroker database';

        var activeIndicators = getActiveIndicators();
        var apiConfigs = activeIndicators.map(function(c) {
            return { type: c.type, params: c.params };
        });

        var url = '/api/ohlcv/' + encodeURIComponent(ctx.symbol)
            + '?entry_date=' + encodeURIComponent(ctx.entryDate)
            + '&exit_date=' + encodeURIComponent(ctx.exitDate)
            + '&interval=' + interval;

        if (apiConfigs.length > 0) {
            url += '&indicators=' + encodeURIComponent(JSON.stringify(apiConfigs));
        }

        fetch(url)
            .then(function(r) {
                if (!r.ok) return r.text().then(function(t) { throw new Error('Server error (' + r.status + ')'); });
                return r.json();
            })
            .then(function(data) {
                loadingEl.style.display = 'none';
                if (data.error) {
                    document.getElementById('chartErrorMsg').textContent = data.error;
                    document.getElementById('chartError').classList.remove('d-none');
                    return;
                }
                if (!data.data || data.data.length === 0) {
                    document.getElementById('chartErrorMsg').textContent = 'No bar data available for this date range.';
                    document.getElementById('chartError').classList.remove('d-none');
                    return;
                }

                // Merge overlay/color from toggle configs into API indicator results
                var indicators = data.indicators || [];
                indicators.forEach(function(ind) {
                    var match = activeIndicators.find(function(c) { return c.type === ind.type; });
                    if (match) {
                        ind.overlay = match.overlay;
                        ind.color = match.color;
                    }
                });

                renderCandlestickChart(container, data.data, ctx.entryDate, ctx.exitDate,
                                       ctx.entryPrice, ctx.exitPrice, ctx.tradeType, indicators);
            })
            .catch(function(err) {
                loadingEl.style.display = 'none';
                document.getElementById('chartErrorMsg').textContent = 'Failed to fetch chart data: ' + err.message;
                document.getElementById('chartError').classList.remove('d-none');
            });
    }

    function renderCandlestickChart(container, bars, entryDate, exitDate, entryPrice, exitPrice, tradeType, indicators) {
        // Split indicators into overlay and sub-pane groups
        var overlayInds = indicators.filter(function(i) { return i.overlay !== false && !i.error; });
        var subPaneInds = indicators.filter(function(i) { return i.overlay === false && !i.error; });
        var mainHeight = subPaneInds.length > 0 ? 310 : 400;

        candlestickChart = LightweightCharts.createChart(container, {
            width: container.clientWidth,
            height: mainHeight,
            layout: {
                background: { type: 'solid', color: '#ffffff' },
                textColor: '#333',
                fontSize: 11,
            },
            grid: {
                vertLines: { color: 'rgba(197, 203, 206, 0.4)' },
                horzLines: { color: 'rgba(197, 203, 206, 0.4)' },
            },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: 'rgba(197, 203, 206, 0.8)' },
            timeScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
                timeVisible: true,
                secondsVisible: false,
            },
        });

        // Candlestick series
        tradeCandleSeries = candlestickChart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350',
            borderDownColor: '#ef5350', borderUpColor: '#26a69a',
            wickDownColor: '#ef5350', wickUpColor: '#26a69a',
        });
        tradeCandleSeries.setData(bars);

        // Volume histogram
        tradeVolumeSeries = candlestickChart.addHistogramSeries({
            color: 'rgba(76, 175, 80, 0.3)',
            priceFormat: { type: 'volume' },
            priceScaleId: 'volume',
        });
        candlestickChart.priceScale('volume').applyOptions({
            scaleMargins: { top: 0.8, bottom: 0 },
        });
        tradeVolumeSeries.setData(bars.map(function(b) {
            return {
                time: b.time,
                value: b.volume || 0,
                color: b.close >= b.open ? 'rgba(38,166,154,0.3)' : 'rgba(239,83,80,0.3)',
            };
        }));

        // --- Render overlay indicators on main chart ---
        tradeRenderIndicatorSeries(candlestickChart, tradeMainSeries, overlayInds);

        // --- Create sub-pane for non-overlay indicators ---
        if (subPaneInds.length > 0) {
            tradeCreateSubPane(subPaneInds, bars);
        }

        // --- Entry / exit markers ---
        var markers = [];
        var entryTime = findClosestBarTime(bars, entryDate);
        var exitTime = findClosestBarTime(bars, exitDate);
        if (entryTime) {
            markers.push({
                time: entryTime, position: 'belowBar', color: '#2196F3',
                shape: 'arrowUp', text: 'Entry @ ' + entryPrice.toFixed(1),
            });
        }
        if (exitTime) {
            markers.push({
                time: exitTime, position: 'aboveBar', color: '#FF9800',
                shape: 'arrowDown', text: 'Exit @ ' + exitPrice.toFixed(1),
            });
        }
        if (markers.length > 0) {
            markers.sort(function(a, b) { return a.time - b.time; });
            tradeCandleSeries.setMarkers(markers);
        }

        // --- Data tooltip: crosshair tracking on main chart ---
        candlestickChart.subscribeCrosshairMove(function(param) {
            if (!param.time || !param.point) {
                tradeTooltipState.time = null;
                updateTradeDataTooltip();
                return;
            }
            tradeTooltipState.time = param.time;
            tradeTooltipState.ohlc = null;
            tradeTooltipState.volume = null;
            tradeTooltipState.mainItems = [];
            if (param.seriesData) {
                param.seriesData.forEach(function(val, series) {
                    if (series === tradeCandleSeries && val) {
                        tradeTooltipState.ohlc = val;
                    } else if (series === tradeVolumeSeries && val) {
                        tradeTooltipState.volume = val.value;
                    } else if (series._tooltipName && val && val.value !== undefined) {
                        tradeTooltipState.mainItems.push({
                            name: series._tooltipName, value: val.value,
                            color: series._tooltipColor || '#aaa'
                        });
                    }
                });
            }
            // Update sub-pane indicator values from main chart crosshair
            if (tradeSubPaneChart) {
                tradeTooltipState.subItems = [];
                var subCoord = tradeSubPaneChart.timeScale().timeToCoordinate(param.time);
                var logIdx = subCoord !== null
                    ? tradeSubPaneChart.timeScale().coordinateToLogical(subCoord)
                    : candlestickChart.timeScale().coordinateToLogical(param.point.x);
                Object.keys(tradeSubPaneSeries).forEach(function(key) {
                    var s = tradeSubPaneSeries[key];
                    if (!s || !s._tooltipName) return;
                    try {
                        var dp = s.dataByIndex(logIdx);
                        if (dp && dp.value !== undefined) {
                            tradeTooltipState.subItems.push({
                                name: s._tooltipName, value: dp.value,
                                color: s._tooltipColor || '#aaa',
                            });
                        }
                    } catch(e) {}
                });
            }
            updateTradeDataTooltip();
        });

        // --- Auto-resize ---
        var resizeObserver = new ResizeObserver(function(entries) {
            for (var entry of entries) {
                candlestickChart.applyOptions({ width: entry.contentRect.width });
                if (tradeSubPaneChart) tradeSubPaneChart.applyOptions({ width: entry.contentRect.width });
            }
        });
        resizeObserver.observe(container);

        document.getElementById('candlestickModal').addEventListener('hidden.bs.modal', function() {
            resizeObserver.disconnect();
            document.getElementById('tradeDataTooltip').classList.remove('visible');
        }, { once: true });

        candlestickChart.timeScale().fitContent();
    }

    // --- Render indicator line series on a chart ---
    function tradeRenderIndicatorSeries(chart, seriesMap, indicators) {
        indicators.forEach(function(ind) {
            if (ind.error) return;
            var color = ind.color || '#FF6D00';

            if (ind.series) {
                Object.keys(ind.series).forEach(function(key) {
                    var lineData = ind.series[key];
                    if (!lineData || lineData.length === 0) return;

                    var lineColor = color, lineWidth = 2, lineStyle = 0;
                    if (key === 'upper1' || key === 'lower1' || key === 'upper' || key === 'lower') {
                        lineWidth = 1; lineStyle = 2;
                    }
                    if (key === 'upper2' || key === 'lower2') { lineWidth = 1; lineStyle = 3; }
                    if (key === 'middle' || key === 'vwap' || key === 'adx' || key === 'k') { lineWidth = 2; }
                    if (key === 'plus_di') lineColor = '#00C853';
                    if (key === 'minus_di') lineColor = '#FF1744';
                    if (key === 'd') { lineColor = '#FF9800'; lineStyle = 2; }
                    if (key === 'first_deriv') { lineColor = '#FF5722'; lineWidth = 2; }
                    if (key === 'second_deriv') { lineColor = '#E040FB'; lineWidth = 1; lineStyle = 2; }

                    var seriesTitle = ind.type.toUpperCase() + ' ' + key;
                    var series = chart.addLineSeries({
                        color: lineColor, lineWidth: lineWidth, lineStyle: lineStyle,
                        title: seriesTitle,
                        lastValueVisible: false, priceLineVisible: false,
                    });
                    series._tooltipName = seriesTitle;
                    series._tooltipColor = lineColor;
                    series.setData(lineData);
                    seriesMap[ind.type + '_' + key] = series;
                });
            } else if (ind.data) {
                var seriesTitle = ind.label || ind.type.toUpperCase();
                var series = chart.addLineSeries({
                    color: color, lineWidth: 2,
                    title: seriesTitle,
                    lastValueVisible: false, priceLineVisible: false,
                });
                series._tooltipName = seriesTitle;
                series._tooltipColor = color;
                series.setData(ind.data);
                seriesMap[ind.type] = series;
            }
        });
    }

    // --- Create sub-pane chart for non-overlay indicators ---
    function tradeCreateSubPane(subIndicators, bars) {
        var card = document.getElementById('tradeSubPaneCard');
        card.style.display = 'block';
        var labels = subIndicators.map(function(i) { return i.type.toUpperCase(); });
        document.getElementById('tradeSubPaneLabel').textContent = labels.join(' / ');

        var spContainer = document.getElementById('tradeSubPaneChart');
        tradeSubPaneChart = LightweightCharts.createChart(spContainer, {
            width: spContainer.clientWidth,
            height: 150,
            layout: {
                background: { type: 'solid', color: '#fafafa' },
                textColor: '#333', fontSize: 10,
            },
            grid: {
                vertLines: { color: 'rgba(197, 203, 206, 0.3)' },
                horzLines: { color: 'rgba(197, 203, 206, 0.3)' },
            },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: 'rgba(197, 203, 206, 0.8)' },
            timeScale: {
                borderColor: 'rgba(197, 203, 206, 0.8)',
                timeVisible: true, secondsVisible: false,
            },
        });

        // Render sub-pane indicator series
        tradeRenderIndicatorSeries(tradeSubPaneChart, tradeSubPaneSeries, subIndicators);

        // Threshold lines
        subIndicators.forEach(function(ind) {
            if (ind.type === 'rsi') {
                tradeAddHLine(tradeSubPaneChart, tradeSubPaneSeries, 'rsi_ob', 70, '#FF174480', bars);
                tradeAddHLine(tradeSubPaneChart, tradeSubPaneSeries, 'rsi_os', 30, '#00C85380', bars);
            }
            if (ind.type === 'stochastic') {
                tradeAddHLine(tradeSubPaneChart, tradeSubPaneSeries, 'stoch_ob', 80, '#FF174480', bars);
                tradeAddHLine(tradeSubPaneChart, tradeSubPaneSeries, 'stoch_os', 20, '#00C85380', bars);
            }
            if (ind.type === 'derivative') {
                tradeAddHLine(tradeSubPaneChart, tradeSubPaneSeries, 'deriv_zero', 0, '#9E9E9E80', bars);
            }
        });

        // Sync time scales between main and sub-pane
        var syncingTimeScale = false;
        candlestickChart.timeScale().subscribeVisibleLogicalRangeChange(function() {
            if (syncingTimeScale) return;
            syncingTimeScale = true;
            try {
                var range = candlestickChart.timeScale().getVisibleRange();
                if (range && tradeSubPaneChart) tradeSubPaneChart.timeScale().setVisibleRange(range);
            } catch(e) {}
            syncingTimeScale = false;
        });
        tradeSubPaneChart.timeScale().subscribeVisibleLogicalRangeChange(function() {
            if (syncingTimeScale) return;
            syncingTimeScale = true;
            try {
                var range = tradeSubPaneChart.timeScale().getVisibleRange();
                if (range && candlestickChart) candlestickChart.timeScale().setVisibleRange(range);
            } catch(e) {}
            syncingTimeScale = false;
        });

        // Sync crosshairs
        var syncingCrosshair = false;
        candlestickChart.subscribeCrosshairMove(function(param) {
            if (syncingCrosshair || !tradeSubPaneChart) return;
            syncingCrosshair = true;
            if (!param.time || !param.point) {
                tradeSubPaneChart.clearCrosshairPosition();
            } else {
                var subKeys = Object.keys(tradeSubPaneSeries);
                if (subKeys.length > 0) {
                    var targetSeries = tradeSubPaneSeries[subKeys[0]];
                    var subPrice = 0;
                    try {
                        var coord = tradeSubPaneChart.timeScale().timeToCoordinate(param.time);
                        if (coord !== null) {
                            var li = tradeSubPaneChart.timeScale().coordinateToLogical(coord);
                            var dp0 = targetSeries.dataByIndex(li);
                            if (dp0 && dp0.value !== undefined) subPrice = dp0.value;
                        }
                    } catch(e) {}
                    tradeSubPaneChart.setCrosshairPosition(subPrice, param.time, targetSeries);
                }
            }
            syncingCrosshair = false;
        });
        tradeSubPaneChart.subscribeCrosshairMove(function(param) {
            if (syncingCrosshair || !candlestickChart) return;
            syncingCrosshair = true;
            if (!param.time || !param.point) {
                candlestickChart.clearCrosshairPosition();
            } else if (tradeCandleSeries) {
                var price = 0;
                try {
                    var coord = candlestickChart.timeScale().timeToCoordinate(param.time);
                    if (coord !== null) {
                        var li = candlestickChart.timeScale().coordinateToLogical(coord);
                        var dp = tradeCandleSeries.dataByIndex(li);
                        if (dp && dp.close !== undefined) price = dp.close;
                    }
                } catch(e) {}
                candlestickChart.setCrosshairPosition(price, param.time, tradeCandleSeries);
            }
            syncingCrosshair = false;
        });

        // Sub-pane tooltip updates
        tradeSubPaneChart.subscribeCrosshairMove(function(param) {
            tradeTooltipState.subItems = [];
            if (param.seriesData) {
                param.seriesData.forEach(function(val, series) {
                    if (series._tooltipName && val && val.value !== undefined) {
                        tradeTooltipState.subItems.push({
                            name: series._tooltipName, value: val.value,
                            color: series._tooltipColor || '#aaa'
                        });
                    }
                });
            }
            updateTradeDataTooltip();
        });

        tradeSubPaneChart.timeScale().fitContent();
    }

    function tradeAddHLine(chart, seriesMap, key, value, color, bars) {
        if (seriesMap[key]) return;
        if (!bars || bars.length === 0) return;
        var ld = [
            { time: bars[0].time, value: value },
            { time: bars[bars.length - 1].time, value: value }
        ];
        var s = chart.addLineSeries({
            color: color, lineWidth: 1, lineStyle: 2,
            lastValueVisible: false, priceLineVisible: false,
        });
        s.setData(ld);
        seriesMap[key] = s;
    }

    function updateTradeDataTooltip() {
        var el = document.getElementById('tradeDataTooltip');
        if (!tradeTooltipState.time) {
            el.classList.remove('visible');
            return;
        }

        var html = '';
        var t = tradeTooltipState.time;
        var date = new Date(t * 1000);
        var timeStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        if (currentInterval < 86400) {
            timeStr += '  ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        html += '<div class="tt-time">' + timeStr + '</div>';

        if (tradeTooltipState.ohlc) {
            var o = tradeTooltipState.ohlc;
            var cls = o.close >= o.open ? 'tt-up' : 'tt-down';
            html += '<div class="tt-row"><span class="tt-label">O</span><span class="tt-val ' + cls + '">' + fmtPrice(o.open) + '</span></div>';
            html += '<div class="tt-row"><span class="tt-label">H</span><span class="tt-val ' + cls + '">' + fmtPrice(o.high) + '</span></div>';
            html += '<div class="tt-row"><span class="tt-label">L</span><span class="tt-val ' + cls + '">' + fmtPrice(o.low) + '</span></div>';
            html += '<div class="tt-row"><span class="tt-label">C</span><span class="tt-val ' + cls + '">' + fmtPrice(o.close) + '</span></div>';
        }

        if (tradeTooltipState.volume != null) {
            html += '<div class="tt-row"><span class="tt-label">Vol</span><span class="tt-val">' + fmtVol(tradeTooltipState.volume) + '</span></div>';
        }

        if (tradeTooltipState.mainItems.length > 0) {
            html += '<div class="tt-divider"></div>';
            tradeTooltipState.mainItems.forEach(function(item) {
                html += '<div class="tt-row"><span class="tt-label">' + escHtml(item.name) + '</span>' +
                    '<span class="tt-val" style="color:' + item.color + ';">' + fmtPrice(item.value) + '</span></div>';
            });
        }

        if (tradeTooltipState.subItems.length > 0) {
            html += '<div class="tt-divider"></div>';
            tradeTooltipState.subItems.forEach(function(item) {
                html += '<div class="tt-row"><span class="tt-label">' + escHtml(item.name) + '</span>' +
                    '<span class="tt-val" style="color:' + item.color + ';">' + fmtNum(item.value) + '</span></div>';
            });
        }

        el.innerHTML = html;
        el.classList.add('visible');
    }

    function findClosestBarTime(bars, dateStr) {
        var targetDate = new Date(dateStr);
        if (isNaN(targetDate.getTime())) return null;
        var targetTs = Math.floor(targetDate.getTime() / 1000);
        var closest = null;
        var closestDiff = Infinity;
        for (var i = 0; i < bars.length; i++) {
            var diff = Math.abs(bars[i].time - targetTs);
            if (diff < closestDiff) {
                closestDiff = diff;
                closest = bars[i].time;
            }
        }
        return closest;
    }

    {% endif %}{# end backtest-only candlestick chart block #}

    /* ═══════════════════════════════════════════════════════
       VERSION PREVIEW — Modal Fetch
       ═══════════════════════════════════════════════════════ */
    document.querySelectorAll('.version-preview-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var versionName = this.getAttribute('data-version-name');
            var modal = new bootstrap.Modal(document.getElementById('versionPreviewModal'));
            var loadingEl = document.getElementById('versionPreviewLoading');
            var codeEl = document.getElementById('versionPreviewCode');
            var errorEl = document.getElementById('versionPreviewError');
            var errorMsgEl = document.getElementById('versionPreviewErrorMsg');

            // Reset state
            loadingEl.style.display = 'block';
            codeEl.style.display = 'none';
            errorEl.classList.add('d-none');
            document.getElementById('versionPreviewLabel').innerHTML =
                '<i class="bi bi-eye me-1"></i>Version: ' + versionName;

            modal.show();

            fetch('/api/afl/versions/' + encodeURIComponent(versionName))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    loadingEl.style.display = 'none';
                    if (data.error) {
                        errorMsgEl.textContent = data.error;
                        errorEl.classList.remove('d-none');
                        return;
                    }
                    codeEl.textContent = data.content || data.afl_content || '(empty)';
                    codeEl.style.display = 'block';
                })
                .catch(function(err) {
                    loadingEl.style.display = 'none';
                    errorMsgEl.textContent = 'Failed to load version: ' + err.message;
                    errorEl.classList.remove('d-none');
                });
        });
    });

});
</script>
{% endblock %}
