{% extends "base.html" %}

{% block title %}{{ strategy.name }} — AmiTesting{% endblock %}

{% block extra_head %}
<style>
    .sp-info-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 14px; height: 14px;
        border-radius: 50%;
        border: 1px solid #adb5bd;
        background: transparent;
        color: #6c757d;
        font-size: 0.58rem;
        font-weight: 700;
        font-style: italic;
        font-family: Georgia, serif;
        cursor: pointer;
        padding: 0;
        margin-left: 3px;
        line-height: 1;
        vertical-align: middle;
    }
    .sp-info-btn:hover {
        background: #e9ecef;
        border-color: #6c757d;
        color: #495057;
    }
    .popover.param-info-pop {
        max-width: 340px;
        font-size: 0.78rem;
    }
    .popover.param-info-pop .popover-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.4rem 0.65rem;
    }
    .popover.param-info-pop .pi-close {
        background: none; border: none;
        font-size: 1rem; line-height: 1;
        color: #6c757d; cursor: pointer;
        padding: 0 0 0 0.5rem;
    }
    .popover.param-info-pop .pi-close:hover { color: #000; }
    .popover.param-info-pop .popover-body {
        padding: 0.6rem 0.75rem;
    }
    .pi-section { margin-bottom: 0.4rem; }
    .pi-section:last-child { margin-bottom: 0; }
    .pi-section-label {
        font-weight: 700;
        font-size: 0.68rem;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<!-- ── Breadcrumb ──────────────────────────────────────── -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
        <li class="breadcrumb-item active">{{ strategy.name }}</li>
    </ol>
</nav>

<!-- ── Strategy Header ────────────────────────────────── -->
<div class="d-flex align-items-start justify-content-between mb-4">
    <div>
        <h2 class="fw-bold mb-1">{{ strategy.name }}</h2>
        <p class="text-muted mb-1">
            <code class="small">{{ strategy.id }}</code>
        </p>
        {% if strategy.symbol %}
        <span class="badge bg-light text-dark border">
            <i class="bi bi-tag me-1"></i>{{ strategy.symbol }}
        </span>
        {% endif %}
    </div>
    <div class="d-flex gap-2">
        <a href="/strategy/{{ strategy.id }}/explore" class="btn btn-outline-info">
            <i class="bi bi-graph-up me-1"></i>Explore Indicators
        </a>
        <form method="POST" action="/backtest/run" class="d-flex gap-1 align-items-center">
            <input type="hidden" name="strategy_id" value="{{ strategy.id }}">
            <select class="form-select form-select-sm" name="symbol" id="symbolSelectHeader"
                    data-symbol-selector style="width: auto; max-width: 160px;">
                <option value="">{{ default_symbol }}</option>
                <option value="__ALL__">All</option>
            </select>
            <select class="form-select form-select-sm date-range-selector" name="date_range" id="dateRangeHeader"
                    style="width: auto; max-width: 200px;"
                    title="Data period for backtest">
                <option value="1y" selected>Full Year</option>
                <option value="6m">Last 6 Months</option>
                <option value="3m">Last 3 Months</option>
                <option value="1m">Last 1 Month</option>
                <option disabled>-- From start --</option>
                <option value="1m@0m">1M from start</option>
                <option value="1m@3m">1M @ +3M</option>
                <option value="1m@6m">1M @ +6M</option>
                <option value="1m@9m">1M @ +9M</option>
                <option value="3m@0m">3M from start</option>
                <option value="3m@3m">3M @ +3M</option>
                <option value="3m@6m">3M @ +6M</option>
            </select>
            <button type="submit" class="btn btn-success"
                {% if not db_configured %}disabled{% endif %}>
                <i class="bi bi-play-fill me-1"></i>Run
            </button>
        </form>
    </div>
</div>

{% if strategy.summary %}
<div class="card mb-4">
    <div class="card-body">
        <p class="mb-0">{{ strategy.summary }}</p>
    </div>
</div>
{% endif %}

{% if strategy.description %}
<div class="card mb-4">
    <div class="card-body">
        <h6 class="fw-bold mb-2">Description</h6>
        <div style="white-space: pre-wrap;" class="small">{{ strategy.description }}</div>
    </div>
</div>
{% endif %}

{% if strategy.risk_notes %}
<div class="callout-amber mb-4 d-flex align-items-start gap-2">
    <i class="bi bi-exclamation-triangle-fill text-warning fs-5 mt-1"></i>
    <div>
        <strong>Risk Notes</strong><br>
        {{ strategy.risk_notes }}
    </div>
</div>
{% endif %}

<!-- ── Parameters Panel ──────────────────────────────── -->
{% if params %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="fw-bold mb-0"><i class="bi bi-sliders me-2"></i>Parameters ({{ params|length }})</h6>
        <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editRunModal">
            <i class="bi bi-pencil-square me-1"></i>Edit & Run
        </button>
    </div>
    <div class="card-body p-0">
        <table class="table table-sm table-hover mb-0">
            <thead>
                <tr>
                    <th>Parameter</th>
                    <th class="text-end">Default</th>
                    <th class="text-end">Min</th>
                    <th class="text-end">Max</th>
                    <th class="text-end">Step</th>
                    <th>Type</th>
                </tr>
            </thead>
            <tbody>
                {% for p in params %}
                <tr>
                    <td>
                        <code>{{ p.name }}</code>
                        <button type="button" class="sp-info-btn d-none"
                                data-param-info="{{ p.name }}" tabindex="-1">i</button>
                    </td>
                    <td class="text-end">{{ p.default }}</td>
                    <td class="text-end text-muted">{{ p.min }}</td>
                    <td class="text-end text-muted">{{ p.max }}</td>
                    <td class="text-end text-muted">{{ p.step }}</td>
                    <td>
                        {% if p.type == "optimize" %}
                        <span class="badge bg-warning text-dark">Optimize</span>
                        {% else %}
                        <span class="badge bg-secondary">Param</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- ── Versions ───────────────────────────────────────── -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="fw-bold mb-0">Versions</h4>
    <div class="d-flex gap-2 align-items-center">
        <span class="badge bg-secondary">{{ versions|length }} version{{ 's' if versions|length != 1 }}</span>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newVersionModal">
            <i class="bi bi-plus-lg me-1"></i>New Version
        </button>
    </div>
</div>

{% if not versions %}
<div class="card mb-4">
    <div class="card-body text-center py-4">
        <p class="text-muted mb-2">No versions yet. Create the first version with your AFL code.</p>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newVersionModal">
            <i class="bi bi-plus-lg me-1"></i>Create Version
        </button>
    </div>
</div>
{% else %}
<div class="d-flex align-items-center gap-2 mb-2">
    <small class="text-muted">Symbol for runs:</small>
    <select class="form-select form-select-sm" id="versionSymbolSelect" data-symbol-selector
            style="width: auto; max-width: 180px;"
            onchange="updateVersionSymbol(this.value)">
        <option value="">{{ default_symbol }}</option>
        <option value="__ALL__">All Symbols</option>
    </select>
    <small class="text-muted ms-2">Period:</small>
    <select class="form-select form-select-sm date-range-selector" id="versionDateRange"
            style="width: auto; max-width: 200px;"
            onchange="updateVersionDateRange(this.value)"
            title="Data period for backtest">
        <option value="1y" selected>Full Year</option>
        <option value="6m">Last 6 Months</option>
        <option value="3m">Last 3 Months</option>
        <option value="1m">Last 1 Month</option>
        <option disabled>-- From start --</option>
        <option value="1m@0m">1M from start</option>
        <option value="1m@3m">1M @ +3M</option>
        <option value="1m@6m">1M @ +6M</option>
        <option value="1m@9m">1M @ +9M</option>
        <option value="3m@0m">3M from start</option>
        <option value="3m@3m">3M @ +3M</option>
        <option value="3m@6m">3M @ +6M</option>
    </select>
</div>
<div class="table-responsive mb-4">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Version</th>
                <th>Label</th>
                <th>AFL Lines</th>
                <th>Parameters</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for v in versions %}
            <tr>
                <td><span class="badge bg-primary">v{{ v.version_number }}</span></td>
                <td>{{ v.label or '—' }}</td>
                <td>{{ v.afl_content.split('\n')|length if v.afl_content else 0 }} lines</td>
                <td>{{ v.parameters|length }} params</td>
                <td><small class="text-muted">{{ v.created_at[:19] if v.created_at else 'N/A' }}</small></td>
                <td>
                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-secondary"
                                onclick="showAflPreview('{{ v.id }}')" title="Preview AFL">
                            <i class="bi bi-eye"></i>
                        </button>
                        <form method="POST" action="/backtest/run" class="d-inline">
                            <input type="hidden" name="strategy_id" value="{{ strategy.id }}">
                            <input type="hidden" name="version_id" value="{{ v.id }}">
                            <input type="hidden" name="symbol" value="" class="version-symbol-input">
                            <input type="hidden" name="date_range" value="1y" class="version-daterange-input">
                            <button type="submit" class="btn btn-sm btn-outline-success" title="Run backtest"
                                {% if not db_configured %}disabled{% endif %}>
                                <i class="bi bi-play-fill"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- ── Backtest Runs ──────────────────────────────────── -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="fw-bold mb-0">Backtest Runs</h4>
    <span class="badge bg-secondary">{{ runs|length }} run{{ 's' if runs|length != 1 }}</span>
</div>

{% if not runs %}
<div class="card mb-4">
    <div class="card-body text-center py-4">
        <i class="bi bi-play-circle text-muted" style="font-size: 2rem;"></i>
        <p class="text-muted mt-2 mb-0">No backtest runs yet. Run a backtest to get started.</p>
    </div>
</div>
{% else %}
<div class="table-responsive mb-4">
    <table class="table table-hover align-middle">
        <thead>
            <tr>
                <th>Run ID</th>
                <th>Version</th>
                <th>Status</th>
                <th>Symbol</th>
                <th>Period</th>
                <th>Metrics</th>
                <th>Parameters</th>
                <th>Started</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for r in runs %}
            <tr>
                <td><code class="small">{{ r.id[:8] }}...</code></td>
                <td>
                    {% if r.version %}
                    <span class="badge bg-primary">v{{ r.version.version_number }}</span>
                    {% if r.version.label %}<small class="text-muted ms-1">{{ r.version.label }}</small>{% endif %}
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% set is_opt_run = (r.run_params is defined and r.run_params is mapping and r.run_params.get("run_mode") == 4) or (r.metrics is defined and r.metrics is mapping and r.metrics.get("run_mode") == 4) %}
                    {% if r.status == "completed" %}
                    <span class="badge bg-success">Completed</span>
                    {% elif r.status == "running" %}
                    <span class="badge bg-info"><span class="spinner-border spinner-border-sm me-1"></span>Running</span>
                    {% elif r.status == "failed" %}
                    <span class="badge bg-danger">Failed</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ r.status|title }}</span>
                    {% endif %}
                    {% if is_opt_run %}
                    <span class="badge bg-warning text-dark ms-1">Optimization</span>
                    {% endif %}
                </td>
                <td>
                    {% if r.symbol == '__ALL__' %}
                    <span class="badge bg-info text-white" style="font-size: 0.7rem;"><i class="bi bi-collection me-1"></i>All</span>
                    {% elif r.symbol %}
                    <span class="badge bg-light text-dark border" style="font-size: 0.7rem;">{{ r.symbol }}</span>
                    {% else %}
                    <small class="text-muted">{{ default_symbol }}</small>
                    {% endif %}
                </td>
                <td>
                    {% set dr = r.date_range or (r.run_params.date_range if r.run_params is defined and r.run_params is mapping else '') or '1y' %}
                    {% set dr_labels = {'0m': '0M', '1m': '1M', '3m': '3M', '6m': '6M', '9m': '9M', '1y': '1Y'} %}
                    {% if '@' in dr %}
                        {% set parts = dr.split('@') %}
                        {% set dur_label = dr_labels.get(parts[0], parts[0]) %}
                        {% set off_label = dr_labels.get(parts[1], parts[1]) %}
                        <span class="badge bg-purple text-white border" style="font-size: 0.65rem; background-color: #7952b3 !important;"
                              title="{{ dur_label }} starting {{ off_label }} from data start">
                            {{ dur_label }}@{{ off_label }}
                        </span>
                    {% else %}
                        {% set colors = {'1m': 'bg-warning text-dark', '3m': 'bg-info text-white', '6m': 'bg-primary', '1y': 'bg-secondary'} %}
                        <span class="badge {{ colors.get(dr, 'bg-secondary') }} border" style="font-size: 0.65rem;"
                              title="Last {{ dr_labels.get(dr, dr) }} of data">
                            {{ dr_labels.get(dr, dr) }}
                        </span>
                    {% endif %}
                </td>
                <td>
                    {% if r.metrics %}
                        {% if is_opt_run and r.metrics.combos_tested is defined %}
                        <small>{{ r.metrics.combos_tested }} combos
                        {% if r.metrics.best_net_profit is defined %}, best ${{ "%.2f"|format(r.metrics.best_net_profit) }}{% endif %}
                        </small>
                        {% elif r.metrics.total_trades is defined %}
                        <small>{{ r.metrics.total_trades }} trades
                        {% if r.metrics.total_profit is defined %}, ${{ "%.2f"|format(r.metrics.total_profit) }}{% endif %}
                        </small>
                        {% else %}
                        <small class="text-muted">—</small>
                        {% endif %}
                    {% else %}
                    <small class="text-muted">—</small>
                    {% endif %}
                </td>
                <td>
                    {% if r.params %}
                    <div class="d-flex flex-wrap gap-1">
                        {% for p in r.params[:5] %}
                        <span class="badge bg-dark border" style="font-size: 0.65rem;">
                            {{ p.name }}={{ p.default }}
                        </span>
                        {% endfor %}
                        {% if r.params|length > 5 %}
                        <span class="badge bg-secondary" style="font-size: 0.65rem;">+{{ r.params|length - 5 }}</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <small class="text-muted">—</small>
                    {% endif %}
                </td>
                <td><small class="text-muted">{{ r.started_at[:19] if r.started_at else r.created_at[:19] if r.created_at else 'N/A' }}</small></td>
                <td>
                    {% if r.status == "completed" %}
                    <a href="/run/{{ r.id }}" class="btn btn-sm btn-outline-primary">
                        View <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- ── New Version Modal ──────────────────────────────── -->
<div class="modal fade" id="newVersionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form method="POST" action="/strategy/{{ strategy.id }}/version/create">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Version</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="versionLabel" class="form-label">Label</label>
                        <input type="text" class="form-control" id="versionLabel" name="label"
                               placeholder="e.g. Added stop loss, Changed MA periods">
                    </div>
                    <div class="mb-3">
                        <label for="versionAfl" class="form-label">AFL Code <span class="text-danger">*</span></label>
                        <textarea class="form-control font-monospace" id="versionAfl" name="afl_content"
                                  rows="20" required
                                  placeholder="Paste your AFL strategy code here...">{% if versions %}{{ versions[0].afl_content }}{% endif %}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Version</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ── AFL Preview Modal ──────────────────────────────── -->
<div class="modal fade" id="aflPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="aflPreviewTitle">AFL Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre><code id="aflPreviewContent" class="font-monospace small"></code></pre>
            </div>
        </div>
    </div>
</div>

<!-- ── Edit & Run Modal ──────────────────────────────── -->
{% if params and versions %}
<div class="modal fade" id="editRunModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="/strategy/{{ strategy.id }}/run-with-params">
                <input type="hidden" name="version_id" value="{{ versions[0].id }}">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-sliders me-2"></i>Edit Parameters & Run</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Run Mode -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Run Mode</label>
                        <div class="d-flex gap-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="run_mode" id="modeBacktest" value="2" checked onchange="updateRunButton()">
                                <label class="form-check-label" for="modeBacktest">Backtest</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="run_mode" id="modeOptimize" value="4" onchange="updateRunButton()">
                                <label class="form-check-label" for="modeOptimize">Optimization</label>
                            </div>
                        </div>
                        <div id="optimizeWarning" class="alert alert-warning mt-2 py-2 small" style="display: none;">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Optimization runs test all parameter combinations marked as "Optimize" and may take significantly longer.
                        </div>
                    </div>

                    <!-- Symbol Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Symbol</label>
                        <select class="form-select" name="symbol" id="symbolSelect" data-symbol-selector>
                            <option value="">Default ({{ default_symbol }})</option>
                            <option value="__ALL__">All Symbols</option>
                        </select>
                        <div class="form-text">Select the symbol to run the backtest against.</div>
                    </div>

                    <!-- Date Range Selection -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Data Period</label>
                        <div class="d-flex gap-2">
                            <div class="flex-grow-1">
                                <label class="form-label small text-muted mb-1">Duration</label>
                                <select class="form-select date-range-selector" name="date_range_duration" id="modalDuration"
                                        onchange="updateModalDateRange()">
                                    <option value="1m">1 Month</option>
                                    <option value="3m">3 Months</option>
                                    <option value="6m">6 Months</option>
                                    <option value="1y" selected>Full Year</option>
                                </select>
                            </div>
                            <div class="flex-grow-1">
                                <label class="form-label small text-muted mb-1">Start From</label>
                                <select class="form-select" name="date_range_offset" id="modalOffset"
                                        onchange="updateModalDateRange()">
                                    <option value="" selected>End of data (most recent)</option>
                                    <option value="0m">Beginning of data</option>
                                    <option value="3m">+3 months from start</option>
                                    <option value="6m">+6 months from start</option>
                                    <option value="9m">+9 months from start</option>
                                </select>
                            </div>
                        </div>
                        <input type="hidden" name="date_range" id="modalDateRangeValue" value="1y">
                        <div class="form-text" id="dateRangeHint">
                            <span id="dateRangePreview">Using the full year of available data.</span>
                        </div>
                    </div>

                    <!-- Parameters Table -->
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th>Parameter</th>
                                <th style="width: 120px;">Value</th>
                                <th style="width: 80px;" class="text-center">Min</th>
                                <th style="width: 80px;" class="text-center">Max</th>
                                <th style="width: 80px;" class="text-center">Step</th>
                                <th style="width: 100px;" class="text-center">Optimize</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in params %}
                            <tr>
                                <td>
                                    <code>{{ p.name }}</code>
                                    <button type="button" class="sp-info-btn d-none"
                                            data-param-info="{{ p.name }}" tabindex="-1">i</button>
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm"
                                           name="param_{{ p.name }}"
                                           value="{{ p.default }}"
                                           step="{{ p.step }}">
                                </td>
                                <td class="text-center">
                                    <input type="number" class="form-control form-control-sm opt-range"
                                           name="min_{{ p.name }}"
                                           value="{{ p.min }}" step="{{ p.step }}"
                                           data-param="{{ p.name }}"
                                           {% if p.type != 'optimize' %}disabled{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input type="number" class="form-control form-control-sm opt-range"
                                           name="max_{{ p.name }}"
                                           value="{{ p.max }}" step="{{ p.step }}"
                                           data-param="{{ p.name }}"
                                           {% if p.type != 'optimize' %}disabled{% endif %}>
                                </td>
                                <td class="text-center">
                                    <input type="number" class="form-control form-control-sm opt-range"
                                           name="step_{{ p.name }}"
                                           value="{{ p.step }}" step="any"
                                           data-param="{{ p.name }}"
                                           {% if p.type != 'optimize' %}disabled{% endif %}>
                                </td>
                                <td class="text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input" type="checkbox"
                                               name="optimize_{{ p.name }}"
                                               data-param="{{ p.name }}"
                                               onchange="toggleOptRange(this)"
                                               {% if p.type == 'optimize' %}checked{% endif %}>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="runButton"
                        {% if not db_configured %}disabled{% endif %}>
                        <i class="bi bi-play-fill me-1"></i><span id="runButtonText">Run Backtest</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{% include 'partials/strategy_detail_js.html' %}
{% endblock %}
